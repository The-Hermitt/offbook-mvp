<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
  />
  <title>OffBook — Rehearsal</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121923;
      --text:#e6ecf2;
      --muted:#9fb3c8;
      --brand:#4e8cff;
      --brand-2:#7aa2ff;
      --ok:#23c55e;
      --warn:#f59e0b;
      --err:#ef4444;
      --card:#0f141c;
      --input:#0f1722;
      --border:#1a2431;
      --radius:16px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* App frame */
    .app{
      display:flex;
      flex-direction:column;
      min-height:100dvh;
      max-width:560px;
      margin:0 auto;
      position:relative;
      background:
        radial-gradient(1200px 600px at 50% -400px, rgba(78,140,255,.12), transparent 70%),
        linear-gradient(180deg, #0b0f14 0%, #090d12 100%);
    }
    header{
      padding:20px 16px 8px;
      font-weight:700;
      letter-spacing:.2px;
      font-size:20px;
    }
    .content{
      flex:1 1 auto;
      padding: 8px 12px 84px; /* room for tab bar */
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:0 8px 32px rgba(0,0,0,.25);
    }
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .mt8{margin-top:8px}
    .mt12{margin-top:12px}
    .mt16{margin-top:16px}
    .mt24{margin-top:24px}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted)}

    /* Inputs */
    input[type="text"], .textbox, .select, input[type="file"]{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--input);
      color:var(--text);
      padding:12px 12px;
      font-size:15px;
      outline:none;
    }
    textarea.textbox{
      min-height:180px;
      resize:vertical;
    }
    button{
      appearance:none;border:0;cursor:pointer;
      border-radius:12px;
      padding:12px 14px;
      font-weight:600;color:white;background:var(--brand);
    }
    button.secondary{background:#1f2a3a;color:#d7e2ee;border:1px solid var(--border)}
    button.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
    button.full{width:100%}
    button.ok{background:var(--ok)}
    button.warn{background:var(--warn);color:#111}
    button.err{background:var(--err)}

    /* Tabs (bottom nav) */
    .tabs{
      position:fixed;left:50%;bottom:0;transform:translateX(-50%);
      width:100%;max-width:560px;background:rgba(10,14,18,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid var(--border);
      display:grid;grid-template-columns:repeat(6,1fr);
      gap:0;padding:6px 8px 10px;
    }
    .tab{
      display:flex;flex-direction:column;gap:4px;
      align-items:center;justify-content:center;
      padding:8px 4px;border-radius:10px;color:var(--muted);
      font-size:11px;
    }
    .tab.active{color:var(--text);background:#101722;border:1px solid var(--border)}
    .tab .dot{width:6px;height:6px;border-radius:9px;background:transparent}
    .tab.active .dot{background:var(--brand)}
    .sr-only{position:absolute;left:-9999px}

    /* Import inner tabs */
    .inner-tabs{display:flex;background:#0e1520;border:1px solid var(--border);border-radius:12px;padding:4px}
    .inner-tab{
      flex:1;text-align:center;padding:10px;border-radius:10px;font-weight:700;color:var(--muted);cursor:pointer;
    }
    .inner-tab.active{background:#172234;color:#eaf2ff;border:1px solid #1b2a41}

    /* Lists */
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#101722;color:#cfe0f7;font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .list .item{display:flex;align-items:center;justify-content:space-between;background:#0f141c;border:1px solid var(--border);padding:10px 12px;border-radius:10px}

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:68px;transform:translateX(-50%);
      background:#0f1722;border:1px solid var(--border);color:#e9f2ff;
      padding:10px 12px;border-radius:12px;font-size:14px;display:none;
    }
    .toast.show{display:block}

    .banner{background:#0f1826;border:1px solid #193252;color:#cfe0f7;padding:10px 12px;border-radius:10px;font-size:13px}
  </style>

  <!-- pdf.js for local OCR render (only when user taps OCR button) -->
  <script src="https://unpkg.com/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
  <script>
    // configure worker for pdf.js
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@4.6.82/build/pdf.worker.min.js';
    }
  </script>
  <!-- Tesseract for local OCR -->
  <script src="https://unpkg.com/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="app">
    <header>OffBook</header>

    <div class="content">
      <!-- Import -->
      <section id="screen-import" class="panel">
        <div class="row wrap">
          <h2 style="margin:0;font-size:18px">Import</h2>
          <span class="pill">Paste or PDF</span>
        </div>
        <p class="hint mt8">Paste plain text (most reliable) or upload a PDF. After import we’ll detect roles and send you to Assign.</p>

        <div class="inner-tabs mt12">
          <div id="itab-paste" class="inner-tab active" role="button" aria-controls="import-paste">Paste Script Text</div>
          <div id="itab-pdf" class="inner-tab" role="button" aria-controls="import-pdf">Upload PDF</div>
        </div>

        <!-- Paste mode -->
        <div id="import-paste" class="mt16">
          <label class="hint">Paste script here</label>
          <textarea id="paste-text" class="textbox" placeholder="JANE: Hello.
GABE: Hey!
JANE (whispering): Ready?"></textarea>

          <div class="mt12">
            <label class="hint">Title</label>
            <input id="paste-title" type="text" class="textbox" placeholder="Pasted Script" />
          </div>

          <div class="mt16">
            <button id="btn-paste-continue" class="full">Continue</button>
          </div>
          <div id="paste-error" class="hint mt12" style="color:var(--err)"></div>
        </div>

        <!-- PDF mode -->
        <div id="import-pdf" class="mt16" style="display:none">
          <div class="banner">Tip: If your PDF is a scan (images only), use <b>Client OCR (Beta)</b> below.</div>
          <div class="mt12">
            <input id="pdf-file" type="file" accept="application/pdf" />
          </div>
          <div class="mt12">
            <label class="hint">Title</label>
            <input id="pdf-title" type="text" class="textbox" placeholder="Uploaded Script" />
          </div>
          <div class="mt16 row">
            <button id="btn-pdf-upload" class="full">Upload & Continue</button>
          </div>
          <div class="mt12">
            <button id="btn-client-ocr" class="secondary full">Client OCR (Beta) — Use if scanned</button>
            <div class="hint mt8">Runs on your device. We OCR the first 3 pages to avoid long waits; you can increase later.</div>
          </div>
          <div id="pdf-error" class="hint mt12" style="color:var(--err)"></div>
        </div>
      </section>

      <!-- Assign (minimal but functional; populated after import) -->
      <section id="screen-assign" class="panel mt16" style="display:none">
        <div class="row wrap">
          <h2 style="margin:0;font-size:18px">Assign</h2>
          <span class="pill" id="assign-scene-count">0 scenes</span>
        </div>
        <div class="mt8">
          <label class="hint">I am…</label>
          <select id="iam" class="select"></select>
        </div>
        <div class="mt12">
          <label class="hint">Partner voices</label>
          <div id="partner-list" class="list mt8"></div>
        </div>
        <div class="mt16">
          <button id="btn-assign-continue" class="ok full">Continue to Rehearse</button>
        </div>
      </section>

      <!-- Stubs for other tabs (unchanged for this task) -->
      <section id="screen-rehearse" class="panel mt16" style="display:none">
        <h2 style="margin:0 0 8px 0;font-size:18px">Rehearse</h2>
        <p class="hint">This build focuses on Import + Assign. Rehearse functions as before.</p>
      </section>

      <section id="screen-record" class="panel mt16" style="display:none">
        <h2 style="margin:0 0 8px 0;font-size:18px">Record</h2>
        <p class="hint">Camera + Mic required (Project rule). We’ll wire this next.</p>
      </section>

      <section id="screen-gallery" class="panel mt16" style="display:none">
        <h2 style="margin:0 0 8px 0;font-size:18px">Gallery</h2>
        <p class="hint">Your takes will appear here.</p>
      </section>

      <section id="screen-settings" class="panel mt16" style="display:none">
        <h2 style="margin:0 0 8px 0;font-size:18px">Settings</h2>
        <p class="hint">Defaults and storage (placeholder).</p>
      </section>
    </div>

    <!-- Bottom Tabs -->
    <nav class="tabs" role="tablist" aria-label="Main">
      <div class="tab active" data-screen="import" role="button" aria-controls="screen-import">
        <div class="dot"></div>
        <div>Import</div>
      </div>
      <div class="tab" data-screen="assign" role="button" aria-controls="screen-assign">
        <div class="dot"></div>
        <div>Assign</div>
      </div>
      <div class="tab" data-screen="rehearse" role="button" aria-controls="screen-rehearse">
        <div class="dot"></div>
        <div>Rehearse</div>
      </div>
      <div class="tab" data-screen="record" role="button" aria-controls="screen-record">
        <div class="dot"></div>
        <div>Record</div>
      </div>
      <div class="tab" data-screen="gallery" role="button" aria-controls="screen-gallery">
        <div class="dot"></div>
        <div>Gallery</div>
      </div>
      <div class="tab" data-screen="settings" role="button" aria-controls="screen-settings">
        <div class="dot"></div>
        <div>Settings</div>
      </div>
    </nav>

    <div id="toast" class="toast"></div>
  </div>

  <script>
    /**************
     * Utilities  *
     **************/
    const $ = (s,root=document)=> root.querySelector(s);
    const $$ = (s,root=document)=> Array.from(root.querySelectorAll(s));
    const toastEl = $('#toast');
    function toast(msg, ms=1700){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ms); }

    // Secret from ?secret= (no visible control)
    const url = new URL(location.href);
    const SHARED_SECRET = url.searchParams.get('secret') || '';
    const BASE = ''; // same-origin

    const VOICES = [
      {id:'alloy',  label:'Alloy'},
      {id:'amber',  label:'Amber'},
      {id:'nova',   label:'Nova'},
      {id:'verse',  label:'Verse'},
    ];

    let state = {
      script_id: null,
      scenes: [],
      roles: [],
      iam: '',
      voice_map: {},
      lastUploadWasOCR: false,
    };

    function hdrs(json=true){
      const h = json ? {'Content-Type':'application/json'} : {};
      if (SHARED_SECRET) h['X-Shared-Secret'] = SHARED_SECRET;
      return h;
    }

    async function jpost(path, body){
      const res = await fetch(BASE+path, {method:'POST', headers:hdrs(true), body:JSON.stringify(body)});
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    async function jget(path){
      const res = await fetch(BASE+path, {headers:hdrs(false)});
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }

    /*******************
     * Tab navigation  *
     *******************/
    function showScreen(name){
      $$('#screen-import, #screen-assign, #screen-rehearse, #screen-record, #screen-gallery, #screen-settings')
        .forEach(el=> el.style.display = 'none');
      $('#screen-'+name).style.display = 'block';
      $$('.tabs .tab').forEach(t=>t.classList.toggle('active', t.dataset.screen === name));
    }
    $$('.tabs .tab').forEach(t => t.addEventListener('click', () => showScreen(t.dataset.screen)));

    // Inner import tabs
    function showImportTab(which){
      $('#itab-paste').classList.toggle('active', which==='paste');
      $('#itab-pdf').classList.toggle('active', which==='pdf');
      $('#import-paste').style.display = which==='paste' ? 'block' : 'none';
      $('#import-pdf').style.display   = which==='pdf' ? 'block' : 'none';
    }
    $('#itab-paste').addEventListener('click', ()=>showImportTab('paste'));
    $('#itab-pdf').addEventListener('click',  ()=>showImportTab('pdf'));

    /****************
     * Import: text *
     ****************/
    $('#btn-paste-continue').addEventListener('click', async ()=>{
      const text = $('#paste-text').value.trim();
      const title = $('#paste-title').value.trim() || 'Pasted Script';
      $('#paste-error').textContent = '';
      if (!text) { $('#paste-error').textContent = 'Please paste some script text.'; return; }

      try{
        const up = await jpost('/debug/upload_script_text', {title, text});
        state.script_id = up.script_id;
        await loadScenes();
        toast('Script imported');
        showScreen('assign');
        buildAssign();
      }catch(err){
        console.error(err);
        $('#paste-error').textContent = 'Upload failed. Please check your text and try again.';
      }
    });

    /***************
     * Import: PDF *
     ***************/
    $('#btn-pdf-upload').addEventListener('click', async ()=>{
      $('#pdf-error').textContent = '';
      const f = $('#pdf-file').files[0];
      const title = $('#pdf-title').value.trim() || (f ? f.name.replace(/\.pdf$/i,'') : 'Uploaded Script');
      if (!f) { $('#pdf-error').textContent = 'Choose a PDF first.'; return; }

      try{
        const fd = new FormData();
        fd.append('title', title);
        fd.append('pdf', f);
        const res = await fetch('/debug/upload_script_upload', {
          method:'POST',
          headers: SHARED_SECRET ? {'X-Shared-Secret': SHARED_SECRET} : undefined,
          body: fd
        });
        if(!res.ok){
          // common path for scanned PDFs or server OCR disabled
          throw new Error(await res.text());
        }
        const up = await res.json();
        state.script_id = up.script_id;
        state.lastUploadWasOCR = false;
        await loadScenes();
        toast('PDF imported');
        showScreen('assign');
        buildAssign();
      }catch(err){
        console.warn('Server PDF import failed, suggest OCR:', err);
        $('#pdf-error').textContent = 'Server import failed or detected scan. Try Client OCR (Beta) below.';
      }
    });

    // Client OCR (first 3 pages) -> upload as text
    $('#btn-client-ocr').addEventListener('click', async ()=>{
      $('#pdf-error').textContent = '';
      const f = $('#pdf-file').files[0];
      const title = $('#pdf-title').value.trim() || (f ? f.name.replace(/\.pdf$/i,'') : 'OCR Script');
      if (!f) { $('#pdf-error').textContent = 'Choose a PDF first.'; return; }

      try{
        toast('Running OCR on first 3 pages…');
        const text = await ocrPdfFirstPages(f, 3);
        if (!text || text.trim().length < 10) throw new Error('No text detected');
        const up = await jpost('/debug/upload_script_text', {title, text});
        state.script_id = up.script_id;
        state.lastUploadWasOCR = true;
        await loadScenes();
        toast('OCR import complete');
        showScreen('assign');
        buildAssign();
      }catch(err){
        console.error(err);
        $('#pdf-error').textContent = 'OCR failed. Try fewer pages or paste manually.';
      }
    });

    async function ocrPdfFirstPages(file, pageLimit){
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
      const pages = Math.min(pdf.numPages, pageLimit);
      let out = [];
      // serial to keep memory low on phones
      for (let p=1;p<=pages;p++){
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({scale:1.7}); // decent balance
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', {alpha:false});
        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        await page.render({canvasContext: ctx, viewport}).promise;

        const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
          tessedit_char_blacklist: '§•●■□◆◇○●◦◻︎◼︎',
          // lightweight logging
          logger: m => (m.status === 'recognizing text' && m.progress % .25 < .02) ? console.debug(m) : null
        });
        out.push(`\n\n=== PAGE ${p} ===\n${text}\n`);
        // free canvas
        canvas.width = 0; canvas.height = 0;
      }
      // Basic cleanup: collapse multiple blank lines
      return out.join('\n').replace(/\n{3,}/g, '\n\n');
    }

    /****************
     * Assign build *
     ****************/
    async function loadScenes(){
      const data = await jget(`/debug/scenes?script_id=${encodeURIComponent(state.script_id)}`);
      state.scenes = data.scenes || [];
      $('#assign-scene-count').textContent = `${state.scenes.length} scene${state.scenes.length!==1?'s':''}`;
      // collect roles
      const set = new Set();
      for(const sc of state.scenes){
        for(const ln of (sc.lines || [])){
          if (ln.speaker && /^[A-Z][A-Z0-9 ]{1,}$/.test(ln.speaker)) set.add(ln.speaker.trim());
        }
      }
      state.roles = Array.from(set).sort();
      // default iam
      if (!state.iam && state.roles.length) state.iam = state.roles[0];
      // default voices
      const def = VOICES[0].id;
      state.voice_map = Object.fromEntries(state.roles.map(r => [r, def]));
    }

    function buildAssign(){
      // fill "I am…"
      const iam = $('#iam');
      iam.innerHTML = state.roles.map(r => `<option value="${r}" ${state.iam===r?'selected':''}>${r}</option>`).join('');
      iam.onchange = () => { state.iam = iam.value; buildPartnerPickers(); };
      buildPartnerPickers();
    }

    function buildPartnerPickers(){
      const box = $('#partner-list');
      const others = state.roles.filter(r => r !== state.iam);
      if (!others.length){ box.innerHTML = `<div class="hint">No partner roles detected yet.</div>`; return; }
      box.innerHTML = '';
      for (const r of others){
        const wrapper = document.createElement('div');
        wrapper.className = 'item';
        wrapper.innerHTML = `
          <div style="font-weight:700">${r}</div>
          <select class="select" data-role="${r}" style="max-width:160px;margin-left:12px">
            ${VOICES.map(v=>`<option value="${v.id}" ${state.voice_map[r]===v.id?'selected':''}>${v.label}</option>`).join('')}
          </select>
        `;
        box.appendChild(wrapper);
      }
      $$('#partner-list select').forEach(sel=>{
        sel.addEventListener('change', e=>{
          const role = e.target.getAttribute('data-role');
          state.voice_map[role] = e.target.value;
        });
      });
    }

    $('#btn-assign-continue').addEventListener('click', async ()=>{
      // remove your role from voice_map
      const vm = {...state.voice_map}; delete vm[state.iam];
      try{
        await jpost('/debug/set_voice', {script_id: state.script_id, voice_map: vm});
        toast('Voices saved');
        showScreen('rehearse');
      }catch(err){
        console.error(err); toast('Failed to save voices', 2000);
      }
    });

    // Initial screen
    showScreen('import');
    showImportTab('paste');

    // If we just used OCR, surface a banner in Assign
    const assignObserver = new MutationObserver(()=> {
      if ($('#screen-assign').style.display === 'block' && state.lastUploadWasOCR){
        toast('Imported via Client OCR');
        state.lastUploadWasOCR = false;
      }
    });
    assignObserver.observe(document.body, {attributes:true, subtree:true, attributeFilter:['style']});
  </script>
</body>
</html>
