<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
  />
  <title>OffBook — Rehearsal</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121923;
      --text:#e6ecf2;
      --muted:#9fb3c8;
      --brand:#4e8cff;
      --ok:#23c55e;
      --warn:#f59e0b;
      --err:#ef4444;
      --input:#0f1722;
      --border:#1a2431;
      --radius:16px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans";
      background:var(--bg); color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .app{display:flex;flex-direction:column;min-height:100dvh;max-width:560px;margin:0 auto;position:relative}
    header{padding:20px 16px 8px;font-weight:700;font-size:20px}
    .content{flex:1 1 auto;padding:8px 12px 84px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:0 8px 32px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
    .hint{font-size:12px;color:var(--muted)}
    input[type="text"], .textbox, .select, input[type="file"]{
      width:100%;border:1px solid var(--border);border-radius:12px;background:var(--input);color:var(--text);padding:12px 12px;font-size:15px;outline:none;
    }
    textarea.textbox{min-height:180px;resize:vertical}
    button{appearance:none;border:0;cursor:pointer;border-radius:12px;padding:12px 14px;font-weight:600;color:white;background:var(--brand)}
    button.full{width:100%}
    .tabs{position:fixed;left:50%;bottom:0;transform:translateX(-50%);width:100%;max-width:560px;background:rgba(10,14,18,.92);backdrop-filter: blur(10px);border-top:1px solid var(--border);display:grid;grid-template-columns:repeat(6,1fr);gap:0;padding:6px 8px 10px}
    .tab{display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;padding:8px 4px;border-radius:10px;color:#a9b8c9;font-size:11px}
    .tab.active{color:var(--text);background:#101722;border:1px solid var(--border)}
    .inner-tabs{display:flex;background:#0e1520;border:1px solid var(--border);border-radius:12px;padding:4px}
    .inner-tab{flex:1;text-align:center;padding:10px;border-radius:10px;font-weight:700;color:#9fb3c8;cursor:pointer}
    .inner-tab.active{background:#172234;color:#eaf2ff;border:1px solid #1b2a41}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#101722;color:#cfe0f7;font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;align-items:center;justify-content:space-between;background:#0f141c;border:1px solid var(--border);padding:10px 12px;border-radius:10px}
    .toast{position:fixed;left:50%;bottom:68px;transform:translateX(-50%);background:#0f1722;border:1px solid var(--border);color:#e9f2ff;padding:10px 12px;border-radius:12px;font-size:14px;display:none}
    .toast.show{display:block}
    .sr-only{position:absolute;left:-9999px}
  </style>

  <!-- pdf.js + Tesseract for automatic client fallback -->
  <script src="https://unpkg.com/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
  <script> if (window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@4.6.82/build/pdf.worker.min.js'; </script>
  <script src="https://unpkg.com/tesseract.js@5.0.4/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="app">
    <header>OffBook</header>
    <div class="content">
      <!-- Import -->
      <section id="screen-import" class="panel">
        <div class="row wrap">
          <h2 style="margin:0;font-size:18px">Import</h2>
          <span class="pill">Paste or PDF</span>
        </div>
        <p class="hint mt8">Paste plain text (most reliable) or upload a PDF. We’ll handle scanned PDFs automatically.</p>

        <div class="inner-tabs mt12">
          <div id="itab-paste" class="inner-tab active">Paste Script Text</div>
          <div id="itab-pdf" class="inner-tab">Upload PDF</div>
        </div>

        <!-- Paste -->
        <div id="import-paste" class="mt16">
          <label class="hint">Paste script here</label>
          <textarea id="paste-text" class="textbox" placeholder="JANE: Hello.
GABE: Hey!
JANE (whispering): Ready?"></textarea>

          <div class="mt12">
            <label class="hint">Title</label>
            <input id="paste-title" type="text" class="textbox" placeholder="Pasted Script" />
          </div>

          <div class="mt16">
            <button id="btn-paste-continue" class="full">Continue</button>
          </div>
          <div id="paste-error" class="hint mt12" style="color:var(--err)"></div>
        </div>

        <!-- PDF -->
        <div id="import-pdf" class="mt16" style="display:none">
          <div class="mt12">
            <input id="pdf-file" type="file" accept="application/pdf" />
          </div>
          <div class="mt12">
            <label class="hint">Title</label>
            <input id="pdf-title" type="text" class="textbox" placeholder="Uploaded Script" />
          </div>
          <div class="mt16">
            <button id="btn-pdf-upload" class="full">Upload & Continue</button>
          </div>
          <div id="pdf-error" class="hint mt12" style="color:var(--err)"></div>
        </div>
      </section>

      <!-- Assign -->
      <section id="screen-assign" class="panel mt16" style="display:none">
        <div class="row wrap">
          <h2 style="margin:0;font-size:18px">Assign</h2>
          <span class="pill" id="assign-scene-count">0 scenes</span>
        </div>
        <div class="mt8">
          <label class="hint">I am…</label>
          <select id="iam" class="select"></select>
        </div>
        <div class="mt12">
          <label class="hint">Partner voices</label>
          <div id="partner-list" class="list mt8"></div>
        </div>
        <div class="mt16">
          <button id="btn-assign-continue" class="full">Continue to Rehearse</button>
        </div>
      </section>

      <!-- Stubs -->
      <section id="screen-rehearse" class="panel mt16" style="display:none">
        <h2 style="margin:0 0 8px 0;font-size:18px">Rehearse</h2>
        <p class="hint">Render and playback as before.</p>
      </section>
      <section id="screen-record" class="panel mt16" style="display:none">
        <h2 style="margin:0 0 8px 0;font-size:18px">Record</h2>
        <p class="hint">Camera + Mic required (rule).</p>
      </section>
      <section id="screen-gallery" class="panel mt16" style="display:none">
        <h2 style="margin:0 0 8px 0;font-size:18px">Gallery</h2>
        <p class="hint">Your takes will appear here.</p>
      </section>
      <section id="screen-settings" class="panel mt16" style="display:none">
        <h2 style="margin:0 0 8px 0;font-size:18px">Settings</h2>
        <p class="hint">Defaults and storage (placeholder).</p>
      </section>
    </div>

    <!-- Bottom Tabs -->
    <nav class="tabs" role="tablist">
      <div class="tab active" data-screen="import"><div class="dot"></div><div>Import</div></div>
      <div class="tab" data-screen="assign"><div class="dot"></div><div>Assign</div></div>
      <div class="tab" data-screen="rehearse"><div class="dot"></div><div>Rehearse</div></div>
      <div class="tab" data-screen="record"><div class="dot"></div><div>Record</div></div>
      <div class="tab" data-screen="gallery"><div class="dot"></div><div>Gallery</div></div>
      <div class="tab" data-screen="settings"><div class="dot"></div><div>Settings</div></div>
    </nav>

    <div id="toast" class="toast"></div>
  </div>

  <script>
    const $ = (s,root=document)=> root.querySelector(s);
    const $$ = (s,root=document)=> Array.from(root.querySelectorAll(s));
    const toastEl = $('#toast');
    function toast(msg, ms=1600){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ms); }

    // Secret header (from ?secret=)
    const SHARED_SECRET = new URL(location.href).searchParams.get('secret') || '';
    function hdrs(json=true){ const h = json?{'Content-Type':'application/json'}:{}; if(SHARED_SECRET) h['X-Shared-Secret']=SHARED_SECRET; return h; }
    async function jpost(path, body){ const r = await fetch(path,{method:'POST',headers:hdrs(true),body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    async function jget(path){ const r = await fetch(path,{headers:hdrs(false)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }

    const VOICES = [{id:'alloy',label:'Alloy'},{id:'amber',label:'Amber'},{id:'nova',label:'Nova'},{id:'verse',label:'Verse'}];

    let state = { script_id:null, scenes:[], roles:[], iam:'', voice_map:{} };

    // Tabs
    function showScreen(name){ ['import','assign','rehearse','record','gallery','settings'].forEach(n=>$('#screen-'+n).style.display = n===name?'block':'none'); $$('.tabs .tab').forEach(t=>t.classList.toggle('active', t.dataset.screen===name)); }
    $$('.tabs .tab').forEach(t=>t.addEventListener('click',()=>showScreen(t.dataset.screen)));
    function showImportTab(which){ $('#itab-paste').classList.toggle('active',which==='paste'); $('#itab-pdf').classList.toggle('active',which==='pdf'); $('#import-paste').style.display=which==='paste'?'block':'none'; $('#import-pdf').style.display=which==='pdf'?'block':'none'; }
    $('#itab-paste').addEventListener('click',()=>showImportTab('paste')); $('#itab-pdf').addEventListener('click',()=>showImportTab('pdf'));
    showScreen('import'); showImportTab('paste');

    // Paste flow
    $('#btn-paste-continue').addEventListener('click', async ()=>{
      const text = $('#paste-text').value.trim(); const title = $('#paste-title').value.trim() || 'Pasted Script';
      $('#paste-error').textContent=''; if(!text){ $('#paste-error').textContent='Please paste some script text.'; return; }
      try{ const up = await jpost('/debug/upload_script_text',{title,text}); state.script_id=up.script_id; await loadScenes(); showScreen('assign'); buildAssign(); toast('Script imported'); }catch(e){ $('#paste-error').textContent='Upload failed. Try again.'; }
    });

    // PDF flow with automatic OCR fallback
    $('#btn-pdf-upload').addEventListener('click', async ()=>{
      const f = $('#pdf-file').files[0]; const title = $('#pdf-title').value.trim() || (f?f.name.replace(/\.pdf$/i,''):'Uploaded Script');
      $('#pdf-error').textContent=''; if(!f){ $('#pdf-error').textContent='Choose a PDF first.'; return; }
      toast('Processing PDF…');
      try{
        const fd = new FormData(); fd.append('title',title); fd.append('pdf',f);
        const res = await fetch('/debug/upload_script_upload',{method:'POST', headers:SHARED_SECRET?{'X-Shared-Secret':SHARED_SECRET}:undefined, body:fd});
        if(!res.ok) throw new Error(await res.text());
        const up = await res.json(); state.script_id = up.script_id;
        await loadScenes();
        // If no roles found → likely scan → automatic client OCR
        if (state.roles.length === 0) {
          await runClientOCRAndReupload(f, title);
        } else {
          showScreen('assign'); buildAssign(); toast('PDF imported');
        }
      }catch(err){
        // Server failed → automatic client OCR
        await runClientOCRAndReupload(f, title);
      }
    });

    async function runClientOCRAndReupload(file, title){
      try{
        toast('This looks like a scanned PDF — extracting text…');
        const text = await ocrPdfFirstPages(file, 3);
        if (!text || text.trim().length < 10) throw new Error('No text detected');
        const up = await jpost('/debug/upload_script_text', { title: title + ' (OCR)', text });
        state.script_id = up.script_id;
        await loadScenes();
        showScreen('assign'); buildAssign(); toast('Imported via automatic text extraction');
      }catch(e){
        console.error(e);
        $('#pdf-error').textContent = 'Could not extract text. Try pasting the script.';
      }
    }

    async function ocrPdfFirstPages(file, pageLimit){
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
      const pages = Math.min(pdf.numPages, pageLimit);
      let out = [];
      for(let p=1;p<=pages;p++){
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({scale:1.7});
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', {alpha:false});
        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        await page.render({canvasContext: ctx, viewport}).promise;
        const { data: { text } } = await Tesseract.recognize(canvas, 'eng', { logger: ()=>{} });
        out.push(text);
        canvas.width = 0; canvas.height = 0;
      }
      return out.join("\n\n").replace(/\n{3,}/g, '\n\n');
    }

    async function loadScenes(){
      const data = await jget(`/debug/scenes?script_id=${encodeURIComponent(state.script_id)}`);
      state.scenes = data.scenes || [];
      // Roles
      const set = new Set();
      for(const sc of state.scenes){ for(const ln of (sc.lines||[])){ if(ln.speaker && /^[A-Z][A-Z0-9 ]{1,}$/.test(ln.speaker)) set.add(ln.speaker.trim()); } }
      state.roles = Array.from(set).sort();
      if (!state.iam && state.roles.length) state.iam = state.roles[0];
      const def = VOICES[0].id; state.voice_map = Object.fromEntries(state.roles.map(r=>[r,def]));
      $('#assign-scene-count').textContent = `${state.scenes.length} scene${state.scenes.length!==1?'s':''}`;
    }

    function buildAssign(){
      const iamSel = $('#iam'); iamSel.innerHTML = state.roles.map(r=>`<option value="${r}" ${state.iam===r?'selected':''}>${r}</option>`).join('');
      iamSel.onchange = ()=>{ state.iam = iamSel.value; buildPartnerPickers(); };
      buildPartnerPickers();
    }
    function buildPartnerPickers(){
      const box = $('#partner-list'); const others = state.roles.filter(r=>r!==state.iam);
      if(!others.length){ box.innerHTML = `<div class="hint">No partner roles detected yet.</div>`; return; }
      box.innerHTML = ''; for(const r of others){
        const wrap = document.createElement('div'); wrap.className='item';
        wrap.innerHTML = `<div style="font-weight:700">${r}</div>
          <select class="select" data-role="${r}" style="max-width:160px;margin-left:12px">
            ${[{id:'alloy',label:'Alloy'},{id:'amber',label:'Amber'},{id:'nova',label:'Nova'},{id:'verse',label:'Verse'}].map(v=>`<option value="${v.id}" ${state.voice_map[r]===v.id?'selected':''}>${v.label}</option>`).join('')}
          </select>`;
        box.appendChild(wrap);
      }
      $$('#partner-list select').forEach(sel=> sel.addEventListener('change', e=>{ state.voice_map[e.target.getAttribute('data-role')] = e.target.value; }));
    }
    $('#btn-assign-continue').addEventListener('click', async ()=>{
      const vm = {...state.voice_map}; delete vm[state.iam];
      try{ await jpost('/debug/set_voice', {script_id:state.script_id, voice_map:vm}); showScreen('rehearse'); toast('Voices saved'); }catch{ toast('Failed to save voices', 2000); }
    });
  </script>
</body>
</html>
