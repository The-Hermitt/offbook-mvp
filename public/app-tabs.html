<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OffBook – Rehearsal MVP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0f14; --card:#111826; --fg:#f5f7fb; --muted:#9aa5b1; --line:#1f2a37; --accent:#3b82f6; --good:#22c55e; --chip:#1b2430; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:900px;margin:12px auto 84px;padding:0 16px}
    .card{padding:16px;border:1px solid var(--line);border-radius:16px;background:var(--card);box-shadow:0 1px 8px rgba(0,0,0,.25)}
    h1{font-size:24px;margin:6px 0 8px}
    p.muted{margin:0 0 14px;color:var(--muted)}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input,select,textarea{
      width:100%; padding:12px; border:1px solid var(--line); border-radius:12px; background:#0e1622; color:var(--fg);
      min-height:46px; -webkit-appearance:none; appearance:none;
    }
    input::placeholder,textarea::placeholder{color:#6b7280}
    textarea{min-height:160px;resize:vertical}
    .row{display:grid;gap:12px}
    @media(min-width:760px){.row.two{grid-template-columns:1fr 1fr}}
    button{appearance:none;margin-top:12px;padding:12px 14px;border:0;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    button.ghost{background:transparent;border:1px solid var(--line)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--chip);font-size:12px;margin-left:6px}
    .ok{color:var(--good)} .err{color:#ef4444}
    .log{display:none;margin-top:10px;padding:10px;border:1px dashed var(--line);border-radius:12px;max-height:140px;overflow:auto;background:#0e1622;font:13px/1.5 ui-monospace,Menlo,Consolas,monospace;color:#d1d5db}
    .hidden{display:none}
    .tabbar{position:fixed;left:0;right:0;bottom:0;height:72px;background:#0e1622;border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(6,1fr);z-index:50}
    .tabbtn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;color:#9aa5b1;text-decoration:none;font-size:11px}
    .tabbtn.active{color:#fff}
    .tabbtn svg{width:22px;height:22px;opacity:.9}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .list{display:grid;gap:10px;margin-top:8px}
    .item{padding:10px;border:1px solid var(--line);border-radius:12px;background:#0e1622}
    audio,video{width:100%;margin-top:10px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 2px}
    .chip{padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:#0e1622;cursor:pointer}
    .chip.active{background:var(--accent);border-color:var(--accent);color:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- IMPORT -->
    <div class="card" id="tab-import">
      <div class="topbar"><h1>Import</h1></div>
      <p class="muted">Bring in your script via paste or PDF upload.</p>

      <div class="chips">
        <span class="chip active" data-mode="paste">Paste Script Text</span>
        <span class="chip" data-mode="upload">Upload PDF</span>
      </div>

      <div id="import-paste">
        <label for="paste">Paste script here</label>
        <textarea id="paste" placeholder="JANE: Hello there.
GABE (with feeling)
I didn’t go on purpose."></textarea>
        <div class="row two">
          <div>
            <label for="title-paste">Title</label>
            <input id="title-paste" value="Pasted Script">
          </div>
          <div></div>
        </div>
        <div class="row"><button id="btn-import-paste">Continue</button></div>
      </div>

      <div id="import-upload" class="hidden">
        <label for="file">Upload PDF</label>
        <input id="file" type="file" accept="application/pdf">
        <div class="row two">
          <div>
            <label for="title-upload">Title</label>
            <input id="title-upload" value="Uploaded Script">
          </div>
          <div></div>
        </div>
        <div class="row"><button id="btn-import-upload">Continue</button></div>
      </div>

      <div id="log-import" class="log"></div>
    </div>

    <!-- ASSIGN -->
    <div class="card hidden" id="tab-assign">
      <div class="topbar">
        <h1>Assign</h1>
        <div class="pill" id="scene-pill">scene: —</div>
      </div>
      <div class="row two">
        <div>
          <label for="role">I am…</label>
          <select id="role"></select>
        </div>
        <div>
          <label for="defaultVoice">Default partner voice</label>
          <input id="defaultVoice" value="alloy">
        </div>
      </div>
      <div id="partnersBox" class="list"></div>
      <div class="row" style="justify-content:flex-end;display:flex;gap:8px">
        <button class="ghost" id="btn-assign-back">Back</button>
        <button id="btn-assign-next">Continue</button>
      </div>
      <div id="log-assign" class="log"></div>
    </div>

    <!-- REHEARSE -->
    <div class="card hidden" id="tab-rehearse">
      <div class="topbar">
        <h1>Rehearse</h1>
        <div>
          <span style="margin-right:8px;color:var(--muted);font-weight:600">Auto-cue</span>
          <label style="display:inline-flex;gap:8px;align-items:center"><input id="autocue" type="checkbox" checked> <span class="pill">UI only</span></label>
        </div>
      </div>

      <div id="prep" class="item">Preparing reader…</div>

      <div id="rehearse-ui" class="hidden">
        <div class="item">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><strong id="role-label">Role: —</strong></div>
            <div id="line-count" class="pill">Line —/—</div>
          </div>
          <div id="line-box" style="margin-top:10px;min-height:80px"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="ghost" id="btn-prev">Prev</button>
            <button id="btn-play">Play</button>
            <button class="ghost" id="btn-next">Next</button>
          </div>
        </div>
      </div>

      <audio id="reader" preload="none" class="hidden"></audio>
      <div id="log-rehearse" class="log"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="ghost" id="btn-rehearse-back">Back</button>
        <button id="btn-rehearse-next">Next</button>
      </div>
    </div>

    <!-- RECORD -->
    <div class="card hidden" id="tab-record">
      <div class="topbar"><h1>Record</h1></div>
      <p class="muted">Headphones recommended to avoid echo.</p>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="btn-rec-start">Start</button>
        <button id="btn-rec-stop" disabled>Stop</button>
      </div>
      <audio id="takePreview" controls preload="none"></audio>
      <div class="row">
        <div>
          <label for="takeLabel">Label</label>
          <input id="takeLabel" placeholder="e.g., Scene 1 – Take 1">
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btn-save-take" class="ghost" disabled>Save to Gallery</button>
        </div>
      </div>
      <div id="log-record" class="log"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="ghost" id="btn-record-back">Back</button>
        <button id="btn-record-next">Next</button>
      </div>
    </div>

    <!-- GALLERY -->
    <div class="card hidden" id="tab-gallery">
      <div class="topbar"><h1>Gallery</h1></div>
      <div id="takesList" class="list"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="ghost" id="btn-gallery-back">Back</button>
      </div>
      <div id="log-gallery" class="log"></div>
    </div>
  </div>

  <!-- Bottom Tab Bar -->
  <nav class="tabbar">
    <a class="tabbtn active" data-tab="import" title="Import">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l4 4h-3v6h-2V7H8l4-4z"/><path d="M5 19h14v2H5z"/></svg>
      <span>Import</span>
    </a>
    <a class="tabbtn" data-tab="assign" title="Assign">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 100-10 5 5 0 000 10z"/><path d="M4 22a8 8 0 0116 0H4z"/></svg>
      <span>Assign</span>
    </a>
    <a class="tabbtn" data-tab="rehearse" title="Rehearse">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
      <span>Rehearse</span>
    </a>
    <a class="tabbtn" data-tab="record" title="Record">
      <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="6"/></svg>
      <span>Record</span>
    </a>
    <a class="tabbtn" data-tab="gallery" title="Gallery">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14"/><rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" fill="none"/><circle cx="8" cy="8" r="2"/></svg>
      <span>Gallery</span>
    </a>
    <a class="tabbtn" data-tab="settings" title="Settings" id="go-settings">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14,12.94a7.43,7.43,0,0,0,.05-1l2-1.55-2-3.46-2.35.49a7.42,7.42,0,0,0-.86-.5L14.5,3H9.5L8,6.92a7.42,7.42,0,0,0-.86.5L4.79,6.93,2.79,10.39,4.79,12a7.43,7.43,0,0,0,0,1l-2,1.55,2,3.46,2.35-.49,2-3.46Z"/><circle cx="12" cy="12" r="3" fill="#0b0f14"/></svg>
      <span>Settings</span>
    </a>
  </nav>

  <script>
    const state = {
      base: window.location.origin,
      secret: new URLSearchParams(location.search).get('secret') || '',
      scriptId: null, sceneId: null, roles: [], myRole: null,
      voiceMap: {}, readerUrl: null, lines: [], currentLine: 1,
      takes: []
    };

    const $ = (id) => document.getElementById(id);
    const showLog = (box, text, cls='') => { const d=$(box); d.style.display='block'; const p=document.createElement('div'); p.textContent=text; if(cls)p.className=cls; d.appendChild(p); d.scrollTop=d.scrollHeight; };
    const uniq = (a) => [...new Set(a)];

    // server call helper
    async function api(method, path, body, isFormData=false){
      const headers = isFormData ? {} : { 'Content-Type': 'application/json' };
      if (state.secret) headers['X-Shared-Secret'] = state.secret;
      const res = await fetch(`${state.base}${path}`, { method, headers, body: isFormData ? body : (body ? JSON.stringify(body) : undefined) });
      const json = await res.json().catch(()=>({}));
      if (!res.ok) throw new Error(json.error || res.statusText);
      return json;
    }

    // role cleaner (client-side safety net)
    function cleanRoles(rs){
      return uniq((rs||[])
        .filter(Boolean)
        .map(r=>String(r).trim())
        .filter(r => r !== 'UNKNOWN')
        .filter(r => /[A-Za-z]/.test(r))                // must contain a letter
        .filter(r => !/^\d{1,4}$/.test(r))              // no pure page numbers
        .filter(r => !/^(INT|EXT|SCENE)\b/.test(r))     // not scene heads
        .filter(r => !/^CONT'?D$/.test(r))              // not CONT'D
      );
    }

    function setTab(name){
      ['import','assign','rehearse','record','gallery'].forEach(t=>{
        const card = document.getElementById(`tab-${t}`);
        if (!card) return;
        card.classList.toggle('hidden', t!==name);
        document.querySelectorAll('.tabbtn').forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
      });
      if (name==='rehearse') ensurePrepared();
    }

    // chips
    document.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
        ch.classList.add('active');
        const mode = ch.dataset.mode;
        $('import-paste').classList.toggle('hidden', mode!=='paste');
        $('import-upload').classList.toggle('hidden', mode!=='upload');
        $('log-import').style.display='none'; $('log-import').innerHTML='';
      });
    });

    // IMPORT: Paste
    $('btn-import-paste').onclick = async ()=>{
      $('btn-import-paste').disabled = true; $('log-import').style.display='none'; $('log-import').innerHTML='';
      try{
        const text=$('paste').value.trim(), title=$('title-paste').value.trim();
        if (!text) throw new Error('Please paste your script text first.');
        const up = await api('POST','/debug/upload_script_text',{ text, title });
        await afterImport(up);
      }catch(e){ showLog('log-import',`Error: ${e.message}`,'err'); }
      finally{ $('btn-import-paste').disabled = false; }
    };

    // IMPORT: Upload
    $('btn-import-upload').onclick = async ()=>{
      $('btn-import-upload').disabled = true; $('log-import').style.display='none'; $('log-import').innerHTML='';
      try{
        const f = $('file').files[0]; if (!f) throw new Error('Choose a PDF file first.');
        const title = $('title-upload').value.trim();
        const fd = new FormData(); fd.append('pdf', f); fd.append('title', title);
        const up = await api('POST','/debug/upload_script_upload', fd, true);
        await afterImport(up);
      }catch(e){ showLog('log-import',`Error: ${e.message}`,'err'); }
      finally{ $('btn-import-upload').disabled = false; }
    };

    // after import → Assign
    async function afterImport(up){
      state.scriptId = up.script_id;
      const sc = await api('GET', `/debug/scenes?script_id=${encodeURIComponent(state.scriptId)}`);
      const scene = sc.scenes?.[0]; if(!scene) throw new Error('No scenes returned');

      state.sceneId = scene.id;
      state.lines = scene.lines || [];

      // roles from lines, then clean
      const rawRoles = uniq(state.lines.map(l=>l.speaker).filter(Boolean));
      state.roles = cleanRoles(rawRoles);
      if (!state.roles.length) state.roles = ['UNKNOWN'];

      $('scene-pill').textContent = `scene: ${state.sceneId}`;
      const sel = $('role'); sel.innerHTML = ''; state.roles.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; sel.appendChild(o); });
      state.myRole = sel.value;
      buildPartnersUI();
      setTab('assign');
    }

    // ASSIGN
    $('role').addEventListener('change', ()=>{ state.myRole=$('role').value; buildPartnersUI(); });
    $('defaultVoice').addEventListener('input', buildPartnersUI);

    function buildPartnersUI(){
      const box=$('partnersBox'); box.innerHTML='';
      const defaultVoice=$('defaultVoice').value || 'alloy';
      const partners=(state.roles||[]).filter(r=>r!==state.myRole);
      if(!partners.length){
        const div=document.createElement('div');
        div.className='item';
        div.innerHTML='<span class="muted">No partner roles detected. Try a script format like:<br><br><code>JANE: Hello there.</code></span>';
        box.appendChild(div);
      } else {
        partners.forEach(name=>{
          const div=document.createElement('div'); div.className='item';
          div.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <div style="font-weight:800">${name}</div>
            <input id="voice_${name}" value="${defaultVoice}" style="max-width:220px">
          </div>`;
          box.appendChild(div);
        });
      }
    }

    $('btn-assign-back').onclick = ()=> setTab('import');
    $('btn-assign-next').onclick = async ()=>{
      $('btn-assign-next').disabled=true; $('log-assign').style.display='none'; $('log-assign').innerHTML='';
      try{
        const defaultVoice=$('defaultVoice').value||'alloy';
        const partners=(state.roles||[]).filter(r=>r!==state.myRole);
        const map={}; if(!partners.length) map['UNKNOWN']=defaultVoice; else partners.forEach(n=>{ map[n]=(document.getElementById(`voice_${n}`)?.value||defaultVoice).trim(); });
        state.voiceMap = map; await api('POST','/debug/set_voice',{ script_id: state.scriptId, voice_map: map }); setTab('rehearse');
      }catch(e){ showLog('log-assign',`Error: ${e.message}`,'err'); }
      finally{ $('btn-assign-next').disabled=false; }
    };

    // REHEARSE
    function updateLineUI(){
      document.getElementById('role-label').textContent = `Role: ${state.myRole || '—'}`;
      document.getElementById('line-count').textContent = `Line ${state.currentLine}/${state.lines.length||'—'}`;
      const you = (state.lines[state.currentLine-1]?.speaker===state.myRole);
      document.getElementById('line-box').innerHTML = you
        ? `<div style="color:#86efac"><strong>${state.myRole} (You)</strong></div><div style="margin-top:6px">${state.lines[state.currentLine-1]?.text||''}</div>`
        : `<div style="color:#93c5fd"><strong>Partner</strong></div><div style="margin-top:6px">${state.lines[state.currentLine-1]?.text||''}</div>`;
    }
    document.getElementById('btn-prev').onclick = ()=>{ if(state.currentLine>1){ state.currentLine--; updateLineUI(); } };
    document.getElementById('btn-next').onclick = ()=>{ if(state.currentLine < (state.lines.length||1)){ state.currentLine++; updateLineUI(); } };

    async function ensurePrepared(){
      document.getElementById('prep').classList.remove('hidden');
      document.getElementById('rehearse-ui').classList.add('hidden');
      const player = document.getElementById('reader'); player.src=''; document.getElementById('btn-play').textContent='Play';
      try{
        const rr = await api('POST','/debug/render',{ script_id: state.scriptId, scene_id: state.sceneId, role: state.myRole, pace: 'normal' });
        if(!rr.render_id) throw new Error('No render_id');
        let status='pending', url='';
        while(status!=='complete'){ const st=await api('GET',`/debug/render_status?render_id=${encodeURIComponent(rr.render_id)}`); status=st.status; url=st.download_url||''; if(status!=='complete') await new Promise(r=>setTimeout(r,600)); }
        state.readerUrl = `${state.base}${url}`; player.src=state.readerUrl;
        document.getElementById('prep').classList.add('hidden'); document.getElementById('rehearse-ui').classList.remove('hidden'); updateLineUI();
      }catch(e){ document.getElementById('prep').textContent = `Error preparing reader: ${e.message}`; }
    }
    const player = document.getElementById('reader');
    document.getElementById('btn-play').onclick = ()=>{ if(!player.src) return; if(player.paused){ player.play().catch(()=>{}); document.getElementById('btn-play').textContent='Pause'; } else { player.pause(); document.getElementById('btn-play').textContent='Play'; } };
    document.getElementById('btn-rehearse-back').onclick = ()=> setTab('assign');
    document.getElementById('btn-rehearse-next').onclick = ()=> setTab('record');

    // RECORD (local only)
    let mediaStream=null, mediaRec=null, chunks=[];
    document.getElementById('btn-record-back').onclick = ()=> setTab('rehearse');
    document.getElementById('btn-record-next').onclick = ()=> setTab('gallery');
    document.getElementById('btn-rec-start').onclick = async ()=>{
      document.getElementById('log-record').style.display='none'; document.getElementById('log-record').innerHTML='';
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRec = new MediaRecorder(mediaStream); chunks=[];
        mediaRec.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
        mediaRec.onstop = ()=>{
          const blob = new Blob(chunks, { type:'audio/webm' });
          const url = URL.createObjectURL(blob);
          document.getElementById('takePreview').src = url; document.getElementById('takePreview').play().catch(()=>{});
          document.getElementById('btn-save-take').disabled=false;
        };
        mediaRec.start(); document.getElementById('btn-rec-start').disabled=true; document.getElementById('btn-rec-stop').disabled=false;
      }catch(e){ showLog('log-record',`Error: ${e.message}`,'err'); }
    };
    document.getElementById('btn-rec-stop').onclick = ()=>{
      try{
        mediaRec?.stop(); mediaStream?.getTracks().forEach(t=>t.stop());
        document.getElementById('btn-rec-start').disabled=false; document.getElementById('btn-rec-stop').disabled=true;
      }catch{}
    };
    document.getElementById('btn-save-take').onclick = ()=>{
      const label = (document.getElementById('takeLabel').value||'').trim() || `Take ${state.takes.length+1}`;
      const src = document.getElementById('takePreview').src; if(!src) return;
      state.takes.push({ label, url: src }); document.getElementById('takeLabel').value=''; document.getElementById('btn-save-take').disabled=true;
      refreshGallery(); setTab('gallery');
    };

    function refreshGallery(){
      const list=document.getElementById('takesList'); list.innerHTML='';
      if(!state.takes.length){ const p=document.createElement('div'); p.className='item'; p.textContent='No takes yet. Record a take to see it here.'; list.appendChild(p); return; }
      state.takes.forEach(t=>{ const div=document.createElement('div'); div.className='item'; div.innerHTML=`<div style="display:flex;gap:10px;align-items:center;justify-content:space-between"><div><strong>${t.label}</strong></div><div><a class="ghost" style="padding:8px 10px;border-radius:10px" href="${t.url}" download="${t.label.replace(/\s+/g,'_')}.webm">Download</a></div></div><audio controls src="${t.url}"></audio>`; list.appendChild(div); });
    }

    // bottom nav
    document.querySelectorAll('.tabbtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tab = btn.dataset.tab;
        if (tab==='settings') { alert('Settings coming soon'); return; }
        setTab(tab);
      });
    });
  </script>
</body>
</html>
