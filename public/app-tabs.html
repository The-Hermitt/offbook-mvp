<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OffBook – Rehearsal MVP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0f14; --card:#111826; --fg:#f5f7fb; --muted:#98a2b3; --line:#1f2a37; --accent:#3b82f6; --good:#22c55e; --chip:#1b2430; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:900px;margin:12px auto 84px;padding:0 16px}
    .card{padding:16px;border:1px solid var(--line);border-radius:16px;background:var(--card);box-shadow:0 1px 8px rgba(0,0,0,.25)}
    h1{font-size:24px;margin:6px 0 8px}
    p.muted{margin:0 0 14px;color:var(--muted)}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input,select,textarea{
      width:100%; padding:12px; border:1px solid var(--line); border-radius:12px; background:#0e1622; color:var(--fg);
      min-height:46px; -webkit-appearance:none; appearance:none;
    }
    input::placeholder,textarea::placeholder{color:#6b7280}
    textarea{min-height:160px;resize:vertical}
    .row{display:grid;gap:12px}
    @media(min-width:760px){.row.two{grid-template-columns:1fr 1fr}}
    button{appearance:none;margin-top:12px;padding:12px 14px;border-radius:12px;border:1px solid var(--accent);background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    button.ghost{background:transparent;color:var(--fg);border-color:var(--line)}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .list{display:grid;gap:10px;margin-top:8px}
    .item{padding:10px;border:1px solid var(--line);border-radius:12px;background:#0e1622}
    audio,video{width:100%;margin-top:10px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 2px}
    .chip{padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:#0e1622;cursor:pointer}
    .chip.active{background:var(--accent);border-color:var(--accent);color:#fff}
    .pill{background:#0e1622;border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:#cbd5e1;font-weight:700}
    .log{display:none;margin-top:12px;padding:10px;border:1px solid var(--line);border-radius:12px;background:#0e1622;white-space:pre-wrap}
    .log.err{border-color:#ef4444;color:#fecaca}
    .tabs{position:fixed;left:0;right:0;bottom:0;background:rgba(11,15,20,.9);backdrop-filter:blur(8px);border-top:1px solid var(--line)}
    .tabs-inner{max-width:900px;margin:0 auto;display:grid;grid-template-columns:repeat(6,1fr);gap:6px;padding:10px 16px}
    .tabbtn{padding:8px;border:1px solid transparent;border-radius:10px;text-align:center;color:#cbd5e1;background:transparent}
    .tabbtn.active{border-color:var(--accent);color:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- IMPORT -->
    <div class="card" id="tab-import">
      <div class="topbar"><h1>Import</h1></div>
      <p class="muted">Paste plain text (most reliable), or upload a PDF. After import we’ll detect roles and move to Assign.</p>

      <div class="chips">
        <span class="chip active" data-mode="paste">Paste Script Text</span>
        <span class="chip" data-mode="upload">Upload PDF</span>
      </div>

      <div id="import-paste">
        <label for="paste">Paste script here</label>
        <textarea id="paste" placeholder="JANE: Hello there.
GABE (with feeling)
I didn’t go on purpose."></textarea>
        <div class="row two">
          <div>
            <label for="title-paste">Title</label>
            <input id="title-paste" value="Pasted Script">
          </div>
          <div></div>
        </div>
        <div class="row"><button id="btn-import-paste">Continue</button></div>
      </div>

      <div id="import-upload" class="hidden">
        <label for="file">Upload PDF</label>
        <input id="file" type="file" accept="application/pdf">
        <div class="row two">
          <div>
            <label for="title-upload">Title</label>
            <input id="title-upload" value="Uploaded Script">
          </div>
          <div></div>
        </div>
        <div class="row"><button id="btn-import-upload">Continue</button></div>
      </div>

      <div id="log-import" class="log"></div>
    </div>

    <!-- ASSIGN -->
    <div class="card hidden" id="tab-assign">
      <div class="topbar">
        <h1>Assign</h1>
        <div class="pill" id="scene-pill">scene: —</div>
      </div>
      <div class="row two">
        <div>
          <label for="role">I am…</label>
          <select id="role"></select>
        </div>
      </div>
      <div id="partnersBox" class="list"></div>
      <div class="row" style="justify-content:flex-end;display:flex;gap:8px">
        <button class="ghost" id="btn-assign-back">Back</button>
        <button id="btn-assign-next">Continue</button>
      </div>
      <div id="log-assign" class="log"></div>
    </div>

    <!-- REHEARSE -->
    <div class="card hidden" id="tab-rehearse">
      <div class="topbar">
        <h1>Rehearse</h1>
        <div>
          <span style="margin-right:8px;color:var(--muted);font-weight:600">Auto-cue</span>
          <span class="pill" id="role-label"></span>
          <span class="pill" id="line-count"></span>
        </div>
      </div>

      <div id="prep" class="item">
        <strong>Preparing reader track…</strong>
        <div class="muted" style="margin-top:6px">We’ll speak your partners’ lines; your lines are silent.</div>
      </div>

      <div id="rehearse-ui" class="hidden">
        <div id="line-box" class="item"></div>
        <audio id="reader" controls preload="none"></audio>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button class="ghost" id="btn-prev">Prev</button>
          <button id="btn-play">Play</button>
          <button class="ghost" id="btn-next">Next</button>
        </div>
      </div>

      <div id="log-rehearse" class="log"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="ghost" id="btn-rehearse-back">Back</button>
        <button id="btn-rehearse-next">Next</button>
      </div>
    </div>

    <!-- RECORD -->
    <div class="card hidden" id="tab-record">
      <div class="topbar"><h1>Record</h1></div>
      <p class="muted">Headphones recommended to avoid echo.</p>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="btn-rec-start">Start</button>
        <button id="btn-rec-stop" disabled>Stop</button>
      </div>
      <audio id="takePreview" controls preload="none"></audio>
      <div class="row">
        <div>
          <label for="takeLabel">Label</label>
          <input id="takeLabel" placeholder="e.g., Scene 1 – Take 1">
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btn-save-take" class="ghost" disabled>Save to Gallery</button>
        </div>
      </div>
      <div id="log-record" class="log"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="ghost" id="btn-record-back">Back</button>
        <button id="btn-record-next">Next</button>
      </div>
    </div>

    <!-- GALLERY -->
    <div class="card hidden" id="tab-gallery">
      <div class="topbar"><h1>Gallery</h1></div>
      <div id="takesList" class="list"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="ghost" id="btn-gallery-back">Back</button>
      </div>
    </div>
  </div>

  <!-- Bottom tabs -->
  <div class="tabs">
    <div class="tabs-inner">
      <button class="tabbtn active" data-tab="import">Import</button>
      <button class="tabbtn" data-tab="assign">Assign</button>
      <button class="tabbtn" data-tab="rehearse">Rehearse</button>
      <button class="tabbtn" data-tab="record">Record</button>
      <button class="tabbtn" data-tab="gallery">Gallery</button>
      <button class="tabbtn" data-tab="settings">Settings</button>
    </div>
  </div>

  <script>
    // tiny helpers
    const $ = (id)=>document.getElementById(id);
    const log = (box, msg, cls='') => { const d=$(box); d.style.display='block'; const p=document.createElement('div'); p.textContent=msg; p.className=cls; d.appendChild(p); d.scrollTop=d.scrollHeight; };
    const uniq = (a) => [...new Set(a)];

    // server call helper
    async function api(method, path, body, isFormData=false){
      const headers = isFormData ? {} : { 'Content-Type': 'application/json' };
      if (state.secret) headers['X-Shared-Secret'] = state.secret;
      const res = await fetch(`${state.base}${path}`, { method, headers, body: isFormData ? body : (body ? JSON.stringify(body) : undefined) });
      const json = await res.json().catch(()=>({}));
      if (!res.ok) throw new Error(json.error || res.statusText);
      return json;
    }

    // role cleaner (client-side safety net)
    function cleanRoles(rs){
      return uniq((rs||[])
        .filter(Boolean)
        .map(r=>String(r).trim())
        .filter(r => r !== 'UNKNOWN')
        .filter(r => /[A-Za-z]/.test(r))                // must contain a letter
        .filter(r => !/^\d{1,4}$/.test(r))              // no pure page numbers
        .filter(r => !/^(INT|EXT|SCENE)\b/.test(r))     // not scene heads
        .filter(r => !/^CONT'?D$/.test(r))              // not CONT'D
      );
    }

    function setTab(name){
      ['import','assign','rehearse','record','gallery'].forEach(t=>{
        const card = document.getElementById(`tab-${t}`);
        if (!card) return;
        card.classList.toggle('hidden', t!==name);
        document.querySelectorAll('.tabbtn').forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
      });
      if (name==='rehearse') ensurePrepared();
    }

    // global state
    const params = new URLSearchParams(location.search);
    const state = {
      base: location.origin || '',
      secret: params.get('secret') || '',
      scriptId: '',
      sceneId: '',
      lines: [],
      roles: [],
      myRole: '',
      currentLine: 1,
      voiceMap: {},
      takes: [],
    };

    // chip toggle
    document.querySelectorAll('.chip').forEach(chip=>{
      chip.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(c=>c.classList.toggle('active', c===chip));
        const mode = chip.dataset.mode;
        $('import-paste').classList.toggle('hidden', mode!=='paste');
        $('import-upload').classList.toggle('hidden', mode!=='upload');
        $('log-import').style.display='none'; $('log-import').innerHTML='';
      });
    });

    // IMPORT: Paste
    $('btn-import-paste').onclick = async ()=>{
      $('btn-import-paste').disabled = true; $('log-import').style.display='none'; $('log-import').innerHTML='';
      try{
        const text=$('paste').value.trim(), title=$('title-paste').value.trim();
        if (!text) throw new Error('Please paste your script text first.');
        const up = await api('POST','/debug/upload_script_text',{ text, title });
        await afterImport(up);
      }catch(e){ log('log-import',`Error: ${e.message}`,'err'); }
      finally{ $('btn-import-paste').disabled = false; }
    };

    // IMPORT: Upload PDF
    $('btn-import-upload').onclick = async ()=>{
      $('btn-import-upload').disabled = true; $('log-import').style.display='none'; $('log-import').innerHTML='';
      try{
        const f=$('file').files[0]; if (!f) throw new Error('Choose a PDF file first.');
        const title = $('title-upload').value.trim();
        const fd = new FormData(); fd.append('pdf', f); fd.append('title', title);
        const up = await api('POST','/debug/upload_script_upload', fd, true);
        await afterImport(up);
      }catch(e){ log('log-import',`Error: ${e.message}`,'err'); }
      finally{ $('btn-import-upload').disabled = false; }
    };

    // after import → Assign
    async function afterImport(up){
      state.scriptId = up.script_id;
      const sc = await api('GET', `/debug/scenes?script_id=${encodeURIComponent(state.scriptId)}`);
      const scene = sc.scenes?.[0]; if(!scene) throw new Error('No scenes returned');

      state.sceneId = scene.id;
      state.lines = scene.lines || [];

      // roles from lines, then clean
      const rawRoles = uniq(state.lines.map(l=>l.speaker).filter(Boolean));
      state.roles = cleanRoles(rawRoles);
      if (!state.roles.length) state.roles = ['UNKNOWN'];

      $('scene-pill').textContent = `scene: ${state.sceneId}`;
      const sel = $('role'); sel.innerHTML = ''; state.roles.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; sel.appendChild(o); });
      state.myRole = sel.value;
      buildPartnersUI();
      setTab('assign');
    }

    // Available AI voice presets
    const VOICE_PRESETS = [
      { id: 'alloy', label: 'Alloy' },
      { id: 'verse', label: 'Verse' },
      { id: 'coral', label: 'Coral' },
      { id: 'ash', label: 'Ash' },
      { id: 'lira', label: 'Lira' },
      { id: 'amber', label: 'Amber' },
      { id: 'slate', label: 'Slate' }
    ];

    // ASSIGN
    $('role').addEventListener('change', ()=>{ state.myRole=$('role').value; buildPartnersUI(); });

    function buildPartnersUI(){
      const box=$('partnersBox'); box.innerHTML='';
      const partners=(state.roles||[]).filter(r=>r!==state.myRole);
      if(!partners.length){
        const div=document.createElement('div');
        div.className='item';
        div.innerHTML='<span class="muted">No partner roles detected. Try a script format like:<br><br><code>JANE: Hello there.</code></span>';
        box.appendChild(div);
      } else {
        partners.forEach(name=>{
          const div=document.createElement('div'); div.className='item';
          const selectId = `voice_${name}`;
          const current = (state.voiceMap && state.voiceMap[name]) || 'alloy';
          const options = VOICE_PRESETS.map(v=>`<option value="${v.id}" ${v.id===current?'selected':''}>${v.label}</option>`).join('');
          div.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <div style="font-weight:800">${name}</div>
            <select id="${selectId}" style="max-width:220px">${options}</select>
          </div>`;
          box.appendChild(div);
        });
      }
    }

    $('btn-assign-back').onclick = ()=> setTab('import');
    $('btn-assign-next').onclick = async ()=>{
      $('btn-assign-next').disabled=true; $('log-assign').style.display='none'; $('log-assign').innerHTML='';
      try{
        const partners=(state.roles||[]).filter(r=>r!==state.myRole);
        const map={}; 
        if(!partners.length){ map['UNKNOWN']='alloy'; }
        else {
          partners.forEach(n=>{ 
            const sel = document.getElementById(`voice_${n}`);
            map[n] = (sel ? sel.value : 'alloy').trim();
          });
        }
        state.voiceMap = map; 
        await api('POST','/debug/set_voice',{ script_id: state.scriptId, voice_map: map });
        setTab('rehearse');
      }catch(e){ log('log-assign',`Error: ${e.message}`,'err'); }
      finally{ $('btn-assign-next').disabled=false; }
    };

    // REHEARSE
    function updateLineUI(){
      document.getElementById('role-label').textContent = `Role: ${state.myRole || '—'}`;
      document.getElementById('line-count').textContent = `Line ${state.currentLine}/${state.lines.length||'—'}`;
      const you = (state.lines[state.currentLine-1]?.speaker===state.myRole);
      document.getElementById('line-box').innerHTML = you
        ? `<div style="color:#86efac"><strong>${state.myRole} (You)</strong></div><div style="margin-top:6px">${state.lines[state.currentLine-1]?.text||''}</div>`
        : `<div style="color:#93c5fd"><strong>Partner</strong></div><div style="margin-top:6px">${state.lines[state.currentLine-1]?.text||''}</div>`;
    }
    document.getElementById('btn-prev').onclick = ()=>{ if(state.currentLine>1){ state.currentLine--; updateLineUI(); } };
    document.getElementById('btn-next').onclick = ()=>{ if(state.currentLine<(state.lines.length||1)){ state.currentLine++; updateLineUI(); } };

    async function ensurePrepared(){
      document.getElementById('prep').classList.remove('hidden');
      document.getElementById('rehearse-ui').classList.add('hidden');
      const player = document.getElementById('reader'); player.src=''; document.getElementById('btn-play').textContent='Play';
      try{
        const rr = await api('POST','/debug/render',{ script_id: state.scriptId, scene_id: state.sceneId, role: state.myRole, pace: 'normal' });
        if(!rr.render_id) throw new Error('No render_id');
        let status='pending', url='';
        while(status!=='complete'){ const st=await api('GET',`/debug/render_status?render_id=${encodeURIComponent(rr.render_id)}`); status=st.status; url=st.download_url||''; if(status!=='complete') await new Promise(r=>setTimeout(r, 800)); }
        if(!url) throw new Error('No download_url');
        player.src=url;
        document.getElementById('prep').classList.add('hidden');
        document.getElementById('rehearse-ui').classList.remove('hidden');
        state.currentLine=1; updateLineUI();
      }catch(e){ log('log-rehearse',`Error: ${e.message}`,'err'); }
    }

    document.getElementById('btn-play').onclick = ()=>{
      const p=document.getElementById('reader');
      if (p.paused) { p.play(); document.getElementById('btn-play').textContent='Pause'; }
      else { p.pause(); document.getElementById('btn-play').textContent='Play'; }
    };
    document.getElementById('btn-rehearse-back').onclick = ()=> setTab('assign');
    document.getElementById('btn-rehearse-next').onclick = ()=> setTab('record');

    // RECORD
    let rec, chunks=[];
    document.getElementById('btn-rec-start').onclick = async ()=>{
      try{
        const s=await navigator.mediaDevices.getUserMedia({ audio:true });
        rec=new MediaRecorder(s); chunks=[]; rec.ondataavailable=e=>{ if(e.data.size>0) chunks.push(e.data); }; rec.onstop=()=>{
          const blob=new Blob(chunks,{type:'audio/webm'}); const url=URL.createObjectURL(blob);
          const p=$('takePreview'); p.src=url; $('btn-save-take').disabled=false;
        }; rec.start(); $('btn-rec-start').disabled=true; $('btn-rec-stop').disabled=false;
      }catch(e){ log('log-record',`Error: ${e.message}`,'err'); }
    };
    document.getElementById('btn-rec-stop').onclick = ()=>{
      try{ rec?.stop(); $('btn-rec-start').disabled=false; $('btn-rec-stop').disabled=true; }catch{}
    };
    document.getElementById('btn-save-take').onclick = ()=>{
      const url=$('takePreview').src; if(!url) return;
      const label=$('takeLabel').value.trim()||`Take ${state.takes.length+1}`;
      state.takes.push({ id: String(Date.now()), label, url });
      renderTakes();
    };
    document.getElementById('btn-record-back').onclick = ()=> setTab('rehearse');
    document.getElementById('btn-record-next').onclick = ()=> setTab('gallery');

    function renderTakes(){
      const list=$('takesList'); list.innerHTML='';
      if(!state.takes.length){ const div=document.createElement('div'); div.className='item'; div.innerHTML='<span class="muted">No saved takes yet.</span>'; list.appendChild(div); return; }
      state.takes.forEach(t=>{ const div=document.createElement('div'); div.className='item'; div.innerHTML=`<div style="font-weight:800">${t.label}</div><audio controls src="${t.url}"></audio>`; list.appendChild(div); });
    }

    // bottom nav
    document.querySelectorAll('.tabbtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tab = btn.dataset.tab;
        if (tab==='settings') { alert('Settings coming soon'); return; }
        setTab(tab);
      });
    });
  </script>
</body>
</html>
