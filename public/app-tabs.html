<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OffBook â€” Rehearsal MVP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    :root { --bg:#0b0c0f; --panel:#111318; --panel-2:#151823; --text:#eaf0ff; --muted:#a7b0c5; --border:#252a36; --focus:#3b82f6; --accent:#3b82f6; --danger:#ef4444; --maxw:720px; }
    *{ box-sizing:border-box } html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial }
    header{ padding:14px 16px; font-weight:700; letter-spacing:.2px }
    main{ padding:12px 12px 84px; max-width:var(--maxw); margin:0 auto }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px }
    h3,h4{ margin:6px 0 10px } .hint{ color:var(--muted); font-size:12px; line-height:1.4 }
    label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 6px }
    input[type="text"],textarea,select{ width:100%; border:1px solid var(--border); background:#0c0f16; color:var(--text); border-radius:10px; padding:10px 12px; font-size:15px }
    textarea{ min-height:140px; line-height:1.35 }
    .btn{ display:inline-flex; align-items:center; justify-content:center; background:var(--accent); color:#fff; border:none; padding:12px 14px; border-radius:12px; font-weight:700; font-size:15px; min-height:44px }
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border) }
    .btn.ghost{ background:transparent; color:var(--muted); border:1px dashed var(--border) }
    .row{ display:flex; gap:8px } .row>*{ flex:1 }
    .spacer8{ height:8px } .spacer12{ height:12px }
    .tabbar{ position:fixed; bottom:0; left:0; right:0; background:var(--panel-2); border-top:1px solid var(--border); padding:0 8px }
    .tabbar-inner{ max-width:var(--maxw); margin:0 auto; display:grid; grid-template-columns:repeat(6,1fr) }
    .tabbar button{ appearance:none; border:none; background:transparent; color:var(--muted); padding:10px 4px; font-size:12px; font-weight:600 }
    .tabbar button.active{ color:var(--text); background:rgba(255,255,255,.02); border-radius:8px }
    .screen{ display:none } .screen.active{ display:block }
    .inner-tabs{ display:flex; gap:8px }
    .inner-tabs button{ flex:1; border:1px solid var(--border); background:transparent; color:var(--text); padding:10px; border-radius:10px; font-weight:700 }
    .inner-tabs button.active{ background:var(--panel-2); border-color:var(--focus) }
    pre.status{ white-space:pre-wrap; word-break:break-word; background:#0c0f16; border:1px dashed var(--border); border-radius:10px; padding:8px; color:var(--muted); min-height:22px }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#0f1420; font-size:12px; margin-right:6px }
    .small{ font-size:12px; color:var(--muted) }
  </style>
</head>
<body>
  <header>ðŸŽ­ OffBook â€” Rehearsal MVP</header>

  <main>
    <!-- IMPORT -->
    <section id="screen-import" class="screen active">
      <div class="card">
        <h3>Import</h3>
        <p class="hint">Two ways to import. <b>Paste Script Text</b> is most reliable; <b>Upload PDF</b> attempts to extract text, with an OCR fallback for scanned PDFs.</p>
        <div class="spacer8"></div>

        <div class="inner-tabs" role="tablist">
          <button id="tab-text" class="active" role="tab" aria-controls="panel-text" aria-selected="true">Paste Script Text</button>
          <button id="tab-pdf" role="tab" aria-controls="panel-pdf" aria-selected="false">Upload PDF</button>
        </div>
        <div class="spacer12"></div>

        <!-- TEXT PANEL -->
        <div id="panel-text" role="tabpanel" aria-labelledby="tab-text">
          <label>Title</label>
          <input id="titleText" type="text" placeholder="My Sides" />
          <label>Paste script here</label>
          <textarea id="scriptText" placeholder="JANE: Hi.
GABE: Hey.
JANE: Ready?"></textarea>
          <div class="spacer8"></div>
          <div class="row">
            <button id="btnTextUpload" class="btn">Continue â†’ Assign</button>
            <button id="btnTextClear" class="btn secondary">Clear</button>
          </div>
          <div class="spacer12"></div>
          <label>Status</label>
          <pre id="status" class="status"></pre>
        </div>

        <!-- PDF PANEL -->
        <div id="panel-pdf" role="tabpanel" aria-labelledby="tab-pdf" hidden>
          <label>Title</label>
          <input id="titlePdf" type="text" placeholder="My PDF Sides" />
          <label>PDF File</label>
          <input id="pdfFile" type="file" accept="application/pdf" />
          <div class="spacer8"></div>
          <div class="row">
            <button id="btnPdfUpload" class="btn">Upload & Continue</button>
            <button id="btnPdfOcr" class="btn ghost" title="Use OCR if your PDF is scanned images" disabled>Try OCR (slow)</button>
          </div>
          <div class="spacer12"></div>
          <label>Status</label>
          <pre id="statusPdf" class="status"></pre>
          <div class="small">Tip: OCR processes the first 3 pages by default for speed.</div>
        </div>
      </div>
    </section>

    <!-- ASSIGN -->
    <section id="screen-assign" class="screen">
      <div class="card">
        <h3>Assign</h3>
        <div><span class="pill" id="pillScript">script: â€”</span> <span class="pill" id="pillScenes">scenes: 0</span></div>
        <div class="spacer8"></div>
        <label>I amâ€¦</label>
        <select id="selectRole"></select>
        <div class="spacer8"></div>
        <div id="voicePickers"></div>
        <div class="spacer8"></div>
        <button id="btnSaveAssign" class="btn">Save Voices</button>
      </div>
    </section>

    <!-- Stubs -->
    <section id="screen-rehearse" class="screen"><div class="card"><h3>Rehearse</h3><p class="hint">Render reader track next.</p></div></section>
    <section id="screen-record" class="screen"><div class="card"><h3>Record</h3><p class="hint">3-2-1 countdown; camera+mic required for Store.</p></div></section>
    <section id="screen-gallery" class="screen"><div class="card"><h3>Gallery</h3><p class="hint">Saved takes will appear here.</p></div></section>
    <section id="screen-settings" class="screen"><div class="card"><h3>Settings</h3><p class="hint">Defaults & storage (future).</p></div></section>
  </main>

  <!-- Bottom bar -->
  <nav class="tabbar" role="tablist" aria-label="App sections">
    <div class="tabbar-inner">
      <button data-tab="import" class="active" role="tab" aria-selected="true">Import</button>
      <button data-tab="assign" role="tab" aria-selected="false">Assign</button>
      <button data-tab="rehearse" role="tab" aria-selected="false">Rehearse</button>
      <button data-tab="record" role="tab" aria-selected="false">Record</button>
      <button data-tab="gallery" role="tab" aria-selected="false">Gallery</button>
      <button data-tab="settings" role="tab" aria-selected="false">Settings</button>
    </div>
  </nav>

  <!-- Vendor: pdf.js + tesseract.js (browser) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.mjs" type="module"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script type="module">
    const qs = new URLSearchParams(location.search);
    const secret = qs.get("secret") || "";
    const JSON_HDRS = { "Content-Type":"application/json" };
    if (secret) JSON_HDRS["X-Shared-Secret"] = secret;

    function showScreen(name){
      document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
      document.getElementById("screen-"+name).classList.add("active");
      document.querySelectorAll(".tabbar button").forEach(b=>b.classList.remove("active"));
      const btn=document.querySelector(`.tabbar button[data-tab="${name}"]`);
      if(btn) btn.classList.add("active");
    }
    document.querySelectorAll(".tabbar button").forEach(b=>b.addEventListener("click",()=>showScreen(b.dataset.tab)));

    const tabText=document.getElementById("tab-text");
    const tabPdf=document.getElementById("tab-pdf");
    const panelText=document.getElementById("panel-text");
    const panelPdf=document.getElementById("panel-pdf");
    tabText.addEventListener("click",()=>{ tabText.classList.add("active"); tabPdf.classList.remove("active"); panelText.hidden=false; panelPdf.hidden=true; });
    tabPdf.addEventListener("click",()=>{ tabPdf.classList.add("active"); tabText.classList.remove("active"); panelPdf.hidden=false; panelText.hidden=true; });

    const S={ script_id:"", scenes:[], role:"", voice_map:{} };
    const setStatus = msg => document.getElementById("status").textContent = msg || "";
    const setStatusPdf = msg => document.getElementById("statusPdf").textContent = msg || "";

    // Paste Text
    document.getElementById("btnTextUpload").addEventListener("click", async ()=>{
      const title=document.getElementById("titleText").value||"Sides";
      const text=document.getElementById("scriptText").value||"";
      setStatus("Uploading textâ€¦");
      try{
        const r=await fetch("/debug/upload_script_text",{method:"POST",headers:JSON_HDRS,body:JSON.stringify({title,text})});
        const j=await r.json().catch(()=>({}));
        if(!r.ok){ setStatus("Error "+r.status+": "+JSON.stringify(j)); return; }
        setStatus(`OK scenes=${j.scene_count} speakers=${(j.speakers||[]).join(", ")}`);
        S.script_id=j.script_id; await loadScenes(); showScreen("assign");
      }catch(e){ setStatus("Network error: "+e); }
    });
    document.getElementById("btnTextClear").addEventListener("click",()=>{
      document.getElementById("titleText").value=""; document.getElementById("scriptText").value=""; setStatus("");
    });

    // PDF upload (server text extraction)
    const btnPdfUpload = document.getElementById("btnPdfUpload");
    const btnPdfOcr = document.getElementById("btnPdfOcr");
    btnPdfUpload.addEventListener("click", async ()=>{
      const title=document.getElementById("titlePdf").value||"PDF Sides";
      const file=document.getElementById("pdfFile").files[0];
      if(!file){ setStatusPdf("Choose a PDF first."); return; }
      const fd=new FormData(); fd.append("title",title); fd.append("pdf",file);
      const headers={}; if(secret) headers["X-Shared-Secret"]=secret;

      setStatusPdf("Uploading PDFâ€¦");
      try{
        const r=await fetch("/debug/upload_script_upload",{method:"POST",headers,body:fd});
        const j=await r.json().catch(()=>({}));
        if(!r.ok){ setStatusPdf("Error "+r.status+": "+JSON.stringify(j)); return; }
        const sp=(j.speakers||[]).join(", ");
        const note=j.note?(" note="+j.note):"";
        setStatusPdf(`OK scenes=${j.scene_count} speakers=${sp||"(none)"} textLen=${j.textLen||0}${note}`);
        if(j.note==="image-only"||j.note==="parse-error"){ btnPdfOcr.disabled=false; btnPdfOcr.focus(); return; }
        S.script_id=j.script_id; await loadScenes(); showScreen("assign");
      }catch(e){ setStatusPdf("Network error: "+e); }
    });

    // Client-side OCR fallback (first 3 pages by default)
    btnPdfOcr.addEventListener("click", async ()=>{
      const file=document.getElementById("pdfFile").files[0];
      if(!file){ setStatusPdf("Choose a PDF first."); return; }
      btnPdfOcr.disabled=true; setStatusPdf("OCR: loadingâ€¦");

      try{
        const buf = await file.arrayBuffer();
        // Load pdf.js (module already loaded by <script type="module"> above)
        const pdfjsLib = await import("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.mjs");
        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

        const maxPages = Math.min(pdf.numPages, 3); // first 3 pages for speed
        let ocrText = "";
        for(let p=1;p<=maxPages;p++){
          setStatusPdf(`OCR: rendering page ${p}/${maxPages}â€¦`);
          const page = await pdf.getPage(p);
          const viewport = page.getViewport({ scale: 2.0 }); // 2x for better OCR
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = Math.ceil(viewport.width);
          canvas.height = Math.ceil(viewport.height);
          await page.render({ canvasContext: ctx, viewport }).promise;

          setStatusPdf(`OCR: recognizing page ${p}/${maxPages}â€¦`);
          const { data: { text } } = await Tesseract.recognize(canvas, "eng", { logger:()=>{} });
          ocrText += "\n" + text;
        }

        const title=document.getElementById("titlePdf").value||"PDF OCR Sides";
        setStatusPdf("OCR: posting recognized textâ€¦");
        const r=await fetch("/debug/upload_script_text",{method:"POST",headers:JSON_HDRS,body:JSON.stringify({title,text:ocrText})});
        const j=await r.json().catch(()=>({}));
        if(!r.ok){ setStatusPdf("Error "+r.status+": "+JSON.stringify(j)); return; }
        setStatusPdf(`OCR OK scenes=${j.scene_count} speakers=${(j.speakers||[]).join(", ")}`);
        S.script_id=j.script_id; await loadScenes(); showScreen("assign");
      }catch(e){
        setStatusPdf("OCR error: "+e);
        btnPdfOcr.disabled=false;
      }
    });

    async function loadScenes(){
      const r=await fetch("/debug/scenes?script_id="+encodeURIComponent(S.script_id),{headers:JSON_HDRS});
      const j=await r.json().catch(()=>({}));
      if(!r.ok){ setStatus("Error "+r.status+": "+JSON.stringify(j)); return; }
      S.scenes=j.scenes||[]; hydrateAssign();
    }
    function uniqueRoles(){
      const names=new Set(); for(const sc of (S.scenes||[])) for(const ln of (sc.lines||[])) names.add(ln.speaker);
      return Array.from(names).filter(n=>n&&n!=="SYSTEM"&&n!=="NARRATOR");
    }
    function hydrateAssign(){
      document.getElementById("pillScript").textContent="script: "+(S.script_id||"â€”");
      document.getElementById("pillScenes").textContent="scenes: "+(S.scenes?.length||0);
      const roles=uniqueRoles();
      const select=document.getElementById("selectRole");
      select.innerHTML=roles.map(r=>`<option value="${r}">${r}</option>`).join("");
      if(!S.role&&roles.length) S.role=roles[0];
      select.value=S.role||"";
      select.onchange=()=>{ S.role=select.value; buildVoicePickers(); };
      buildVoicePickers();
    }
    function buildVoicePickers(){
      const box=document.getElementById("voicePickers"); box.innerHTML="";
      const presets=["alloy","verse","aria","solar","narrator"];
      const partners=uniqueRoles().filter(n=>n!==S.role);
      partners.forEach(name=>{
        const wrap=document.createElement("div"); wrap.className="card"; wrap.style.marginTop="8px";
        wrap.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <strong>${name}</strong>
          <select data-name="${name}">${presets.map(v=>`<option value="${v}" ${((S.voice_map[name]||presets[0])===v)?"selected":""}>${v}</option>`).join("")}</select>
        </div>`;
        box.appendChild(wrap);
      });
      box.querySelectorAll("select").forEach(el=>{
        el.addEventListener("change",(e)=>{ const sel=e.target; S.voice_map[sel.getAttribute("data-name")]=sel.value; });
      });
    }
    document.getElementById("btnSaveAssign").addEventListener("click", async ()=>{
      if(!S.script_id){ setStatus("Upload a script first."); return; }
      const roles=uniqueRoles().filter(r=>r!==S.role);
      for(const r of roles) if(!S.voice_map[r]) S.voice_map[r]="alloy";
      const resp=await fetch("/debug/set_voice",{method:"POST",headers:JSON_HDRS,body:JSON.stringify({script_id:S.script_id,voice_map:S.voice_map})});
      const j=await resp.json().catch(()=>({}));
      if(!resp.ok){ setStatus("Error "+resp.status+": "+JSON.stringify(j)); return; }
      setStatus("Voices saved. Proceed to Rehearse."); showScreen("rehearse");
    });
  </script>
</body>
</html>
