<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OffBook – Rehearsal MVP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0f14; --card:#111826; --fg:#f5f7fb; --muted:#98a2b3; --line:#1f2a37; --accent:#3b82f6; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:900px;margin:12px auto 84px;padding:0 16px}
    .card{padding:16px;border:1px solid var(--line);border-radius:16px;background:var(--card);box-shadow:0 1px 8px rgba(0,0,0,.25)}
    h1{font-size:24px;margin:6px 0 8px}
    p.muted{margin:0 0 14px;color:var(--muted)}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#0e1622;color:var(--fg);min-height:46px}
    input::placeholder,textarea::placeholder{color:#6b7280}
    textarea{min-height:160px;resize:vertical}
    .row{display:grid;gap:12px}
    @media(min-width:760px){.row.two{grid-template-columns:1fr 1fr}}
    button{appearance:none;margin-top:12px;padding:12px 14px;border-radius:12px;border:1px solid var(--accent);background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    button.ghost{background:transparent;color:var(--fg);border-color:var(--line)}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .list{display:grid;gap:10px;margin-top:8px}
    .item{padding:10px;border:1px solid var(--line);border-radius:12px;background:#0e1622}
    audio{width:100%;margin-top:10px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 2px}
    .chip{padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:#0e1622;cursor:pointer}
    .chip.active{background:var(--accent);border-color:var(--accent);color:#fff}
    .pill{background:#0e1622;border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:#cbd5e1;font-weight:700}
    .log{display:none;margin-top:12px;padding:10px;border:1px solid var(--line);border-radius:12px;background:#0e1622;white-space:pre-wrap;font:13px/1.5 ui-monospace,Menlo,Consolas,monospace;color:#d1d5db}
    .log.err{border-color:#ef4444;color:#fecaca}
    .hidden{display:none}
    .tabbar{position:fixed;left:0;right:0;bottom:0;height:64px;background:rgba(11,15,20,.92);backdrop-filter:blur(8px);border-top:1px solid var(--line)}
    .tabbar nav{max-width:900px;margin:0 auto;height:64px;display:grid;grid-template-columns:repeat(6,1fr);gap:6px;padding:10px 16px}
    .tabbar a{display:flex;flex-direction:column;justify-content:center;align-items:center;gap:2px;text-decoration:none;border:1px solid transparent;border-radius:10px;color:#cbd5e1}
    .tabbar a.active{border-color:var(--accent);color:#fff}
    .tabbar svg{width:22px;height:22px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- IMPORT -->
    <div class="card" id="tab-import">
      <div class="topbar"><h1>Import</h1></div>
      <p class="muted">Paste plain text (most reliable), or upload a PDF. After import we’ll detect roles and move to Assign.</p>

      <div class="chips">
        <span class="chip active" data-mode="paste">Paste Script Text</span>
        <span class="chip" data-mode="upload">Upload PDF</span>
      </div>

      <div id="import-paste">
        <label for="paste">Paste script here</label>
        <textarea id="paste" placeholder="JANE: Hello there.
GABE (with feeling)
I didn’t go on purpose."></textarea>
        <div class="row two">
          <div>
            <label for="title-paste">Title</label>
            <input id="title-paste" value="Pasted Script">
          </div>
          <div></div>
        </div>
        <div class="row"><button id="btn-import-paste">Continue</button></div>
      </div>

      <div id="import-upload" class="hidden">
        <label for="file">Upload PDF</label>
        <input id="file" type="file" accept="application/pdf">
        <div class="row two">
          <div>
            <label for="title-upload">Title</label>
            <input id="title-upload" value="Uploaded Script">
          </div>
          <div></div>
        </div>
        <div class="row"><button id="btn-import-upload">Continue</button></div>
      </div>

      <div id="log-import" class="log"></div>
    </div>

    <!-- ASSIGN -->
    <div class="card hidden" id="tab-assign">
      <div class="topbar">
        <h1>Assign</h1>
        <div class="pill" id="scene-pill">scene: —</div>
      </div>
      <div class="row two">
        <div>
          <label for="role">I am…</label>
          <select id="role"></select>
        </div>
      </div>
      <div id="partnersBox" class="list"></div>
      <div class="row" style="justify-content:flex-end;display:flex;gap:8px">
        <button class="ghost" id="btn-assign-back">Back</button>
        <button id="btn-assign-next">Continue</button>
      </div>
      <div id="log-assign" class="log"></div>
    </div>

    <!-- REHEARSE -->
    <div class="card hidden" id="tab-rehearse">
      <div class="topbar">
        <h1>Rehearse</h1>
        <div>
          <span class="pill" id="role-pill">Role: —</span>
          <span class="pill" id="line-pill">Line —/—</span>
        </div>
      </div>

      <div id="prep" class="item">Preparing reader…</div>

      <div id="rehearse-ui" class="hidden">
        <div id="line-box" class="item"></div>
        <audio id="reader" controls preload="none"></audio>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button class="ghost" id="btn-prev">Prev</button>
          <button id="btn-play">Play</button>
          <button class="ghost" id="btn-next">Next</button>
        </div>
      </div>

      <div id="log-rehearse" class="log"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="ghost" id="btn-rehearse-back">Back</button>
        <button id="btn-rehearse-next">Next</button>
      </div>
    </div>

    <!-- RECORD -->
    <div class="card hidden" id="tab-record">
      <div class="topbar"><h1>Record</h1></div>
      <p class="muted">Headphones recommended to avoid echo.</p>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="btn-rec-start">Start</button>
        <button id="btn-rec-stop" disabled>Stop</button>
      </div>
      <audio id="takePreview" controls preload="none"></audio>
      <div class="row">
        <div>
          <label for="takeLabel">Label</label>
          <input id="takeLabel" placeholder="e.g., Scene 1 – Take 1">
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btn-save-take" class="ghost" disabled>Save to Gallery</button>
        </div>
      </div>
      <div id="log-record" class="log"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="ghost" id="btn-record-back">Back</button>
        <button id="btn-record-next">Next</button>
      </div>
    </div>

    <!-- GALLERY -->
    <div class="card hidden" id="tab-gallery">
      <div class="topbar"><h1>Gallery</h1></div>
      <div id="takesList" class="list"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="ghost" id="btn-gallery-back">Back</button>
      </div>
    </div>
  </div>

  <!-- Bottom Tabs -->
  <div class="tabbar">
    <nav>
      <a href="javascript:void(0)" class="active tabbtn" data-tab="import"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20,8H4A2,2,0,0,0,2,10v8a2,2,0,0,0,2,2H20a2,2,0,0,0,2-2V10A2,2,0,0,0,20,8Zm0,10H4V10H20Z"/><rect x="6" y="12" width="6" height="2"/><rect x="14" y="12" width="4" height="2"/></svg><span>Import</span></a>
      <a href="javascript:void(0)" class="tabbtn" data-tab="assign"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,12a5,5,0,1,0-5-5A5,5,0,0,0,12,12Zm0,2c-4,0-8,2-8,6v2H20V20C20,16,16,14,12,14Z"/></svg><span>Assign</span></a>
      <a href="javascript:void(0)" class="tabbtn" data-tab="rehearse"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M8,5.14V19.14L19,12.14Z"/></svg><span>Rehearse</span></a>
      <a href="javascript:void(0)" class="tabbtn" data-tab="record"><svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="4"/><path d="M19,10v2a7,7,0,0,1-14,0V10H3v2a9,9,0,0,0,18,0V10Z"/></svg><span>Record</span></a>
      <a href="javascript:void(0)" class="tabbtn" data-tab="gallery"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21,3H3A2,2,0,0,0,1,5V19a2,2,0,0,0,2,2H21a2,2,0,0,0,2-2V5A2,2,0,0,0,21,3Zm0,16H3V5H21Z"/><circle cx="8" cy="8" r="1.5"/></svg><span>Gallery</span></a>
      <a href="javascript:void(0)" class="tabbtn" data-tab="settings"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14,12.94a7.49,7.49,0,0,0,.06-1,7.49,7.49,0,0,0-.06-1l2-1.55-2-3.46-2.35.94a7.43,7.43,0,0,0-1.73-1L15.5,2h-4L10.94,4.87a7.43,7.43,0,0,0-1.73,1L6.86,4.94,4.5,8.4l2,1.55a7.49,7.49,0,0,0-.06,1,7.49,7.49,0,0,0,.06,1L4.5,13.5l2.36,3.46,2.35-.94a7.43,7.43,0,0,0,1.73,1L11.5,22h4l.56-2.87a7.43,7.43,0,0,0,1.73-1l2.35.94,2-3.46Z"/><circle cx="12" cy="12" r="3" fill="#0b0f14"/></svg><span>Settings</span></a>
    </nav>
  </div>

  <script>
    // ---------- State ----------
    const params = new URLSearchParams(location.search);
    const state = {
      base: location.origin,
      secret: params.get('secret') || '',
      scriptId: '', sceneId: '',
      roles: [], myRole: '',
      lines: [], currentLine: 1,
      voiceMap: {}, takes: []
    };
    const $ = (id) => document.getElementById(id);
    const uniq = (a)=>[...new Set(a)];
    const showLog=(box,msg,cls='')=>{const d=$(box);d.style.display='block';const p=document.createElement('div');p.textContent=msg;p.className=cls;d.appendChild(p);d.scrollTop=d.scrollHeight;};

    // ---------- API ----------
    async function api(method, path, body, isFormData=false){
      const headers = isFormData ? {} : {'Content-Type':'application/json'};
      if (state.secret) headers['X-Shared-Secret']=state.secret;
      const res = await fetch(`${state.base}${path}`, { method, headers, body: isFormData?body:(body?JSON.stringify(body):undefined) });
      const json = await res.json().catch(()=>({}));
      if (!res.ok) throw new Error(json.error || res.statusText);
      return json;
    }

    // ---------- Tabs ----------
    function setTab(name){
      ['import','assign','rehearse','record','gallery'].forEach(t=>{
        const card=$(`tab-${t}`); if(!card) return;
        card.classList.toggle('hidden', t!==name);
        document.querySelectorAll('.tabbtn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
      });
      if (name==='rehearse') ensurePrepared();
    }
    document.querySelectorAll('.tabbtn').forEach(b=>{
      b.addEventListener('click', ()=>{
        const t=b.dataset.tab;
        if (t==='settings') { alert('Settings coming soon'); return; }
        setTab(t);
      });
    });

    // ---------- Import chips ----------
    document.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
        ch.classList.add('active');
        const mode=ch.dataset.mode;
        $('import-paste').classList.toggle('hidden', mode!=='paste');
        $('import-upload').classList.toggle('hidden', mode!=='upload');
        $('log-import').style.display='none'; $('log-import').innerHTML='';
      });
    });

    // ---------- Import: Paste ----------
    $('btn-import-paste').onclick = async ()=>{
      $('btn-import-paste').disabled=true; $('log-import').style.display='none'; $('log-import').innerHTML='';
      try{
        const text=$('paste').value.trim(), title=$('title-paste').value.trim();
        if (!text) throw new Error('Please paste your script text first.');
        const up = await api('POST','/debug/upload_script_text',{ text, title });
        await afterImport(up);
      }catch(e){ showLog('log-import',`Error: ${e.message}`,'err'); }
      finally{ $('btn-import-paste').disabled=false; }
    };

    // ---------- Import: Upload PDF ----------
    $('btn-import-upload').onclick = async ()=>{
      $('btn-import-upload').disabled=true; $('log-import').style.display='none'; $('log-import').innerHTML='';
      try{
        const f=$('file').files[0]; if(!f) throw new Error('Choose a PDF file first.');
        const title=$('title-upload').value.trim();
        const fd=new FormData(); fd.append('pdf',f); fd.append('title',title);
        const up = await api('POST','/debug/upload_script_upload', fd, true);
        await afterImport(up);
      }catch(e){ showLog('log-import',`Error: ${e.message}`,'err'); }
      finally{ $('btn-import-upload').disabled=false; }
    };

    // ---------- After Import → Assign ----------
    async function afterImport(up){
      state.scriptId = up.script_id;
      const sc = await api('GET', `/debug/scenes?script_id=${encodeURIComponent(state.scriptId)}`);
      const scene = sc.scenes?.[0];
      if (!scene) throw new Error('No scenes returned from parser');

      state.sceneId = scene.id;
      state.lines = scene.lines || [];

      const rawRoles = uniq(state.lines.map(l=>l.speaker).filter(Boolean));
      state.roles = cleanRoles(rawRoles);
      if (!state.roles.length) state.roles = ['UNKNOWN'];

      $('scene-pill').textContent = `scene: ${state.sceneId}`;

      const sel=$('role'); sel.innerHTML='';
      state.roles.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; sel.appendChild(o); });
      state.myRole = sel.value;

      buildPartnersUI();
      setTab('assign');
    }

    function cleanRoles(rs){
      return uniq((rs||[])
        .filter(Boolean)
        .map(r=>String(r).trim())
        .filter(r => r !== 'UNKNOWN')
        .filter(r => /[A-Za-z]/.test(r))
        .filter(r => !/^\d{1,4}$/.test(r))
        .filter(r => !/^(INT|EXT|SCENE)\b/.test(r))
        .filter(r => !/^CONT'?D$/.test(r))
      );
    }

    const VOICE_PRESETS = [
      { id:'alloy', label:'Alloy' },
      { id:'verse', label:'Verse' },
      { id:'coral', label:'Coral' },
      { id:'ash',   label:'Ash' },
      { id:'lira',  label:'Lira' },
      { id:'amber', label:'Amber' },
      { id:'slate', label:'Slate' }
    ];

    $('role').addEventListener('change', ()=>{ state.myRole=$('role').value; buildPartnersUI(); });

    function buildPartnersUI(){
      const box=$('partnersBox'); box.innerHTML='';
      const partners=(state.roles||[]).filter(r=>r!==state.myRole);
      if(!partners.length){
        const div=document.createElement('div'); div.className='item';
        div.innerHTML='<span class="muted">No partner roles detected. Try a script format like:<br><br><code>JANE: Hello there.</code></span>';
        box.appendChild(div);
      } else {
        partners.forEach(name=>{
          const div=document.createElement('div'); div.className='item';
          const current=(state.voiceMap && state.voiceMap[name]) || 'alloy';
          const opts=VOICE_PRESETS.map(v=>`<option value="${v.id}" ${v.id===current?'selected':''}>${v.label}</option>`).join('');
          div.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <div style="font-weight:800">${name}</div>
            <select id="voice_${name}" style="max-width:220px">${opts}</select>
          </div>`;
          box.appendChild(div);
        });
      }
    }

    $('btn-assign-back').onclick = ()=> setTab('import');
    $('btn-assign-next').onclick = async ()=>{
      $('btn-assign-next').disabled=true; $('log-assign').style.display='none'; $('log-assign').innerHTML='';
      try{
        const partners=(state.roles||[]).filter(r=>r!==state.myRole);
        const map={};
        if(!partners.length){ map['UNKNOWN']='alloy'; } else {
          partners.forEach(n=>{ map[n] = (document.getElementById(`voice_${n}`)?.value || 'alloy').trim(); });
        }
        state.voiceMap = map;
        await api('POST','/debug/set_voice',{ script_id: state.scriptId, voice_map: map });
        setTab('rehearse');
      }catch(e){ showLog('log-assign',`Error: ${e.message}`,'err'); }
      finally{ $('btn-assign-next').disabled=false; }
    };

    // ---------- Rehearse ----------
    function updateLineUI(){
      $('role-pill').textContent = `Role: ${state.myRole || '—'}`;
      $('line-pill').textContent = `Line ${state.currentLine}/${state.lines.length||'—'}`;
      const cur = state.lines[state.currentLine-1] || {};
      const you = cur.speaker === state.myRole;
      $('line-box').innerHTML = you
        ? `<div style="color:#86efac"><strong>${state.myRole} (You)</strong></div><div style="margin-top:6px">${cur.text||''}</div>`
        : `<div style="color:#93c5fd"><strong>${cur.speaker||'Partner'}</strong></div><div style="margin-top:6px">${cur.text||''}</div>`;
    }
    $('btn-prev').onclick = ()=>{ if(state.currentLine>1){ state.currentLine--; updateLineUI(); } };
    $('btn-next').onclick = ()=>{ if(state.currentLine<(state.lines.length||1)){ state.currentLine++; updateLineUI(); } };

    async function ensurePrepared(){
      if (!state.scriptId || !state.sceneId || !state.myRole) {
        $('prep').textContent='Import a script and assign roles first.'; return;
      }
      $('prep').classList.remove('hidden');
      $('rehearse-ui').classList.add('hidden');
      const player=$('reader'); player.src=''; $('btn-play').textContent='Play';

      try{
        const rr = await api('POST','/debug/render',{ script_id: state.scriptId, scene_id: state.sceneId, role: state.myRole, pace: 'normal' });
        if(!rr.render_id) throw new Error('No render_id');
        let status='pending', url='';
        while(status!=='complete'){
          const st=await api('GET',`/debug/render_status?render_id=${encodeURIComponent(rr.render_id)}`);
          status=st.status; url=st.download_url||'';
          if(status!=='complete') await new Promise(r=>setTimeout(r,700));
        }
        if (!url) throw new Error('No download_url');
        player.src = url.startsWith('http') ? url : `${state.base}${url}`;
        $('prep').classList.add('hidden');
        $('rehearse-ui').classList.remove('hidden');
        state.currentLine=1; updateLineUI();
      }catch(e){ $('prep').textContent=`Error preparing reader: ${e.message}`; }
    }
    $('btn-play').onclick=()=>{const p=$('reader'); if(p.paused){p.play();$('btn-play').textContent='Pause';} else {p.pause();$('btn-play').textContent='Play';} };

    // ---------- Record ----------
    let rec, chunks=[];
    $('btn-rec-start').onclick = async ()=>{
      try{
        const s=await navigator.mediaDevices.getUserMedia({audio:true});
        rec=new MediaRecorder(s); chunks=[];
        rec.ondataavailable=e=>{ if(e.data.size>0) chunks.push(e.data); };
        rec.onstop=()=>{ const url=URL.createObjectURL(new Blob(chunks,{type:'audio/webm'})); $('takePreview').src=url; $('btn-save-take').disabled=false; };
        rec.start(); $('btn-rec-start').disabled=true; $('btn-rec-stop').disabled=false;
      }catch(e){ showLog('log-record',`Error: ${e.message}`,'err'); }
    };
    $('btn-rec-stop').onclick=()=>{ try{rec?.stop();$('btn-rec-start').disabled=false;$('btn-rec-stop').disabled=true;}catch{} };
    $('btn-save-take').onclick=()=>{ const url=$('takePreview').src; if(!url) return; const label=$('takeLabel').value.trim()||`Take ${state.takes.length+1}`; state.takes.push({id:String(Date.now()),label,url}); renderTakes(); };
    $('btn-record-back').onclick=()=>setTab('rehearse');
    $('btn-record-next').onclick=()=>setTab('gallery');
    function renderTakes(){ const list=$('takesList'); list.innerHTML=''; if(!state.takes.length){ const div=document.createElement('div'); div.className='item'; div.innerHTML='<span class="muted">No saved takes yet.</span>'; list.appendChild(div); return; } state.takes.forEach(t=>{ const div=document.createElement('div'); div.className='item'; div.innerHTML=`<div style="font-weight:800">${t.label}</div><audio controls src="${t.url}"></audio>`; list.appendChild(div); }); }
  </script>
</body>
</html>
