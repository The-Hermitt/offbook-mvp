<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OffBook ‚Äî Audio Diagnostics</title>
<style>
  :root{ --bg:#0b0c0f; --panel:#111318; --text:#eaf0ff; --muted:#a7b0c5; --border:#252a36; --accent:#3b82f6; --ok:#16a34a; --err:#ef4444; --maxw:720px; }
  *{ box-sizing:border-box } html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial }
  header{ padding:14px 16px; font-weight:700 }
  main{ padding:12px; max-width:var(--maxw); margin:0 auto }
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px; margin-bottom:12px }
  .btn{ display:inline-flex; align-items:center; justify-content:center; background:var(--accent); color:#fff; border:none; padding:12px 14px; border-radius:12px; font-weight:700; font-size:15px; min-height:44px; cursor:pointer }
  .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border) }
  .row{ display:flex; gap:8px; flex-wrap:wrap } .row>*{ flex:1 }
  label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 6px }
  pre{ white-space:pre-wrap; word-break:break-word; background:#0c0f16; border:1px dashed var(--border); border-radius:10px; padding:10px; color:#a7b0c5; min-height:80px }
  .ok{ color:var(--ok) } .err{ color:var(--err) }
  .small{ color:var(--muted); font-size:12px }
</style>
</head>
<body>
<header>üé≠ OffBook ‚Äî Audio Diagnostics</header>
<main>
  <div class="card">
    <h3>Native TTS (browser voice)</h3>
    <div class="row">
      <button id="btnNative" class="btn">Run Native TTS Test</button>
      <button id="btnVoices" class="btn secondary">Count Voices</button>
    </div>
    <label>Status</label>
    <pre id="outNative"></pre>
    <div class="small">Tip: Make sure system volume isn‚Äôt muted and headphones are connected if you‚Äôre using them.</div>
  </div>

  <div class="card">
    <h3>Server TTS (OpenAI voice via /debug/tts_line)</h3>
    <div class="row">
      <button id="btnServer" class="btn">Request TTS Clip</button>
      <button id="btnPlay" class="btn secondary" disabled>Play Clip</button>
    </div>
    <label>Status</label>
    <pre id="outServer"></pre>
    <audio id="aud" preload="auto" playsinline></audio>
    <div class="small">Uses query param <code>?secret=‚Ä¶</code> (default <code>1976</code>). Voice: <code>alloy</code>. Text: ‚ÄúShort test from OffBook diagnostics.‚Äù</div>
  </div>

  <div class="card">
    <h3>Back to the app</h3>
    <a class="btn secondary" href="./app-tabs.html">Open OffBook</a>
  </div>
</main>

<script>
  const qs = new URLSearchParams(location.search);
  const secret = qs.get("secret") || "1976";
  const outNative = document.getElementById("outNative");
  const outServer = document.getElementById("outServer");
  const aud = document.getElementById("aud");

  function log(el, msg, cls){ el.innerHTML += (cls?("<span class='"+cls+"'>"+msg+"</span>"):msg) + "\n"; el.scrollTop = el.scrollHeight; }
  function clear(el){ el.textContent = ""; }

  // Ensure voices are loaded (Safari/Chrome can be lazy)
  function loadVoicesOnce(timeoutMs=2000){
    return new Promise(res=>{
      let done=false;
      const voices = window.speechSynthesis?.getVoices?.() || [];
      if(voices.length>0){ return res(voices); }
      const t = setTimeout(()=>{ if(!done){ done=true; res(window.speechSynthesis?.getVoices?.()||[]); } }, timeoutMs);
      if(window.speechSynthesis){
        window.speechSynthesis.onvoiceschanged = ()=>{ if(!done){ done=true; clearTimeout(t); res(window.speechSynthesis.getVoices()||[]); } };
        // poke
        try{ window.speechSynthesis.getVoices(); }catch{}
      }else{
        res([]);
      }
    });
  }

  document.getElementById("btnVoices").onclick = async ()=>{
    clear(outNative);
    const list = await loadVoicesOnce();
    log(outNative, "Voices available: "+list.length);
    list.slice(0,5).forEach(v=>log(outNative, " - "+(v.name||"unknown")+" ["+(v.lang||"?")+"]"));
  };

  document.getElementById("btnNative").onclick = async ()=>{
    clear(outNative);
    if(!window.speechSynthesis || !window.SpeechSynthesisUtterance){
      log(outNative, "speechSynthesis not supported in this browser.", "err"); return;
    }
    const list = await loadVoicesOnce();
    log(outNative, "Voices detected: "+list.length);
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance("OffBook native speech test.");
      const en = (list||[]).find(v=>/en(-|_)?/i.test(v.lang||""));
      if(en) u.voice = en;
      u.onend = ()=>log(outNative, "Played OK.", "ok");
      u.onerror = (e)=>log(outNative, "Native TTS error: "+(e.error||"unknown"), "err");
      window.speechSynthesis.speak(u);
      log(outNative, "Playing‚Ä¶");
    }catch(e){
      log(outNative, "Exception: "+e, "err");
    }
  };

  document.getElementById("btnServer").onclick = async ()=>{
    clear(outServer); aud.removeAttribute("src"); document.getElementById("btnPlay").disabled = true;
    log(outServer, "POST /debug/tts_line ‚Ä¶");
    try{
      const r = await fetch("/debug/tts_line", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "X-Shared-Secret": secret },
        body: JSON.stringify({ voice:"alloy", text:"Short test from OffBook diagnostics." })
      });
      const j = await r.json().catch(()=>({}));
      log(outServer, "HTTP "+r.status);
      if(!r.ok){ log(outServer, "Server returned error body: "+JSON.stringify(j), "err"); return; }
      if(j && j.url){
        aud.src = j.url + "?t=" + Date.now();
        document.getElementById("btnPlay").disabled = false;
        log(outServer, "Got URL ‚úì  (click Play Clip)", "ok");
      }else{
        log(outServer, "No URL in response: "+JSON.stringify(j), "err");
      }
    }catch(e){
      log(outServer, "Network/Fetch error: "+e, "err");
    }
  };

  document.getElementById("btnPlay").onclick = async ()=>{
    try{
      aud.currentTime = 0;
      await aud.play();
      log(outServer, "Playing server clip‚Ä¶");
      aud.onended = ()=>log(outServer, "Finished.", "ok");
    }catch(e){
      log(outServer, "Couldn‚Äôt play (gesture/autoplay). Tap Play again.", "err");
    }
  };
</script>
</body>
</html>
